## 1. 开始

本文为 `Vue3.x` 工程适配记录。项目中很多老工具、组件都是基于 `Vue2.x` 的，而且还在用，所以基本是戴着镣铐跳舞，需要向下兼容，同时追求高效、简单。

## 2. 适配

### 2.1. TIP_PLATFORM_NAME 适配

一个 [Vite 插件](https://mobile.woa.com/uni-plugin-light/zh/vite/cross-platform.html) 即可解决。

但是对于第三方库，需要额外的技巧。

需要在 `vite.config.ts` 中的 `optimizeDepsExcludes` 中将其排除，否则在 `vite` 的依赖分析的时候就会提前报错，此时还没到插件的处理时机。

这样处理后，一些用 `commonjs` 的三方库可能会报错，这时又需要添加 `optimizeDepsIncludes`，让插件处理这些依赖。

### 2.2. 组件库适配

一些三方库是以源码方式提供的，比如 `press-plus`，`Vue2.x` 时可以配置 `transpileDependencies`，但是 `Vite` 没有对应的配置项。

可以这么处理：

1. 将三方库复制到 `src` 下的某个目录下
2. 为三方库配置 `alias`，指向 `src` 某目录下
3. 配置 `tsconfig.json` 的 `compileOptions.paths`

除组件库外，一些类似 `pmd-tools` 的三方库也可以这样处理。需要注意的是，一旦配置 `alias` 为本地源码后，一些依赖要额外安装（比如 `vue-runtime-helpers`），否则在 `pnpm` 项目中可能找不到。

### 2.3. vite 依赖缓存

vite 有依赖缓存，禁用缓存可以用 `sudo npm run dev --force`

### 2.4. 条件编译

项目支持条件编译，一些地方使用它会非常简单。比如 s`rc/component/logic/tip-merchant/jump-handle/helper.js` 中 对 `configInfo` 的适配。

### 2.5. node.js 版本

`node` 版本必须 `>= 16`，可以使用 `nvm` 切换，非常方便。

`devcolud` 已支持。


### 2.6. template v-for

`Vue2.x` 和 `Vue3.x` 的 `:key` 使用互不兼容，前者不能放到 `template` 上，后者必须放到 `template` 上，且是 `vscode` 插件的报错，不是 `eslint` 的报错。

一个简单的解决办法就是把 `template` 改成 `div/span`。

参考：https://v3-migration.vuejs.org/zh/breaking-changes/key-attribute.html

