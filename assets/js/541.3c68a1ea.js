(window.webpackJsonp=window.webpackJsonp||[]).push([[541],{810:function(a,e,t){"use strict";t.r(e);var s=t(14),r=Object(s.a)({},(function(){var a=this,e=a._self._c;return e("ContentSlotsDistributor",{attrs:{"slot-key":a.$parent.slotKey}},[e("p",[a._v("[toc]")]),a._v(" "),e("h2",{attrs:{id:"_1-开始"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_1-开始"}},[a._v("#")]),a._v(" 1. 开始")]),a._v(" "),e("p",[e("code",[a._v("pnpm")]),a._v("意为"),e("code",[a._v("performant npm")]),a._v("，即性能更佳的"),e("code",[a._v("npm")]),a._v("。在时间和空间上，"),e("code",[a._v("pnpm")]),a._v("都有极大提升，快、更节省空间。另外，还顺便解决了幽灵依赖的问题。")]),a._v(" "),e("p",[a._v("社区主流库都迁移了"),e("code",[a._v("pnpm")]),a._v("，比如"),e("a",{attrs:{href:"https://github.com/vuejs/core/pull/4766",target:"_blank",rel:"noopener noreferrer"}},[a._v("vue"),e("OutboundLink")],1),a._v("、"),e("a",{attrs:{href:"https://github.com/vitejs/vite/pull/5060",target:"_blank",rel:"noopener noreferrer"}},[a._v("vitejs"),e("OutboundLink")],1),a._v("、"),e("a",{attrs:{href:"https://github.com/element-plus/element-plus",target:"_blank",rel:"noopener noreferrer"}},[a._v("element-plus"),e("OutboundLink")],1),a._v("。")]),a._v(" "),e("h2",{attrs:{id:"_2-原理"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_2-原理"}},[a._v("#")]),a._v(" 2. 原理")]),a._v(" "),e("p",[e("code",[a._v("pnpm")]),a._v("通过软硬链接的方式存放依赖，"),e("code",[a._v("node_modules")]),a._v("下的第一层文件，指向"),e("code",[a._v("node_modules/.pnpm")]),a._v("中，而"),e("code",[a._v("node_modules/.pnpm")]),a._v("中的包，又以硬链接的方式指向全局"),e("code",[a._v("store")]),a._v("。")]),a._v(" "),e("h2",{attrs:{id:"_3-pnpm迁移"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_3-pnpm迁移"}},[a._v("#")]),a._v(" 3. pnpm迁移")]),a._v(" "),e("p",[a._v("下面是项目迁移"),e("code",[a._v("pnpm")]),a._v("的步骤。")]),a._v(" "),e("h3",{attrs:{id:"_3-1-安装pnpm"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_3-1-安装pnpm"}},[a._v("#")]),a._v(" 3.1. 安装pnpm")]),a._v(" "),e("p",[a._v("注意"),e("code",[a._v("node14")]),a._v("版本只能使用"),e("code",[a._v("pnpm7")]),a._v("及以下，参见"),e("a",{attrs:{href:"https://pnpm.io/installation#compatibility",target:"_blank",rel:"noopener noreferrer"}},[a._v("官网说明"),e("OutboundLink")],1),a._v("。")]),a._v(" "),e("div",{staticClass:"language-bash extra-class"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[e("span",{pre:!0,attrs:{class:"token function"}},[a._v("npm")]),a._v(" i "),e("span",{pre:!0,attrs:{class:"token function"}},[a._v("pnpm")]),a._v(" "),e("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-g")]),a._v("\n")])])]),e("h3",{attrs:{id:"_3-2-生成pnpm-lock-yaml"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_3-2-生成pnpm-lock-yaml"}},[a._v("#")]),a._v(" 3.2. 生成pnpm-lock.yaml")]),a._v(" "),e("p",[a._v("使用项目中的"),e("code",[a._v("package-lock.json")]),a._v("文件生成"),e("code",[a._v("pnpm-lock.yaml")]),a._v("文件。")]),a._v(" "),e("div",{staticClass:"language-bash extra-class"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[e("span",{pre:!0,attrs:{class:"token function"}},[a._v("pnpm")]),a._v(" "),e("span",{pre:!0,attrs:{class:"token function"}},[a._v("import")]),a._v("\n")])])]),e("h3",{attrs:{id:"_3-3-删除node-modules"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_3-3-删除node-modules"}},[a._v("#")]),a._v(" 3.3. 删除node_modules")]),a._v(" "),e("div",{staticClass:"language-bash extra-class"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[e("span",{pre:!0,attrs:{class:"token function"}},[a._v("sudo")]),a._v(" "),e("span",{pre:!0,attrs:{class:"token function"}},[a._v("rm")]),a._v(" "),e("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-rf")]),a._v(" node_modules\n")])])]),e("h3",{attrs:{id:"_3-4-使用pnpm安装依赖"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_3-4-使用pnpm安装依赖"}},[a._v("#")]),a._v(" 3.4. 使用pnpm安装依赖")]),a._v(" "),e("div",{staticClass:"language-bash extra-class"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[e("span",{pre:!0,attrs:{class:"token function"}},[a._v("pnpm")]),a._v(" i\n")])])]),e("h3",{attrs:{id:"_3-5-解决幽灵依赖"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_3-5-解决幽灵依赖"}},[a._v("#")]),a._v(" 3.5. 解决幽灵依赖")]),a._v(" "),e("p",[a._v("幽灵依赖就是没有在"),e("code",[a._v("package.json")]),a._v("中，但是项目中，或者引用的包中使用到的依赖。")]),a._v(" "),e("p",[a._v("我们项目的幽灵依赖包括：")]),a._v(" "),e("ul",[e("li",[a._v("vue-loader")]),a._v(" "),e("li",[a._v("@types/jest")]),a._v(" "),e("li",[a._v("js-base64")]),a._v(" "),e("li",[a._v("tim-upload-plugin")]),a._v(" "),e("li",[a._v("vue-plugin-load-script")]),a._v(" "),e("li",[a._v("...")])]),a._v(" "),e("h2",{attrs:{id:"_4-遇到的问题"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_4-遇到的问题"}},[a._v("#")]),a._v(" 4. 遇到的问题")]),a._v(" "),e("h3",{attrs:{id:"_4-1-loader-utils"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_4-1-loader-utils"}},[a._v("#")]),a._v(" 4.1. loader-utils")]),a._v(" "),e("p",[e("code",[a._v("html-webpack-plugin")]),a._v("版本不能是"),e("code",[a._v("v0.x")]),a._v("版本，需要升级到"),e("code",[a._v("v1.x")]),a._v("，否则会因为"),e("code",[a._v("loader-utils")]),a._v("版本问题而报错：")]),a._v(" "),e("div",{staticClass:"language- extra-class"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[a._v("Syntax Error: TypeError: loaderUtils.getOptions is not a function\n\n\n @ ./src/project/tgs/main.js 14:0-35 221:13-16\n @ multi ./node_modules/.pnpm/webpack-dev-server@3.11.3_webpack@4.46.0/node_modules/webpack-dev-server/client?https://192.168.1.17:443&sockPath=/sockjs-node (webpack)/hot/dev-server.js ./src/project/tgs/main.js\n")])])]),e("p",[a._v("也不能是3，只能是1或者2。")]),a._v(" "),e("h3",{attrs:{id:"_4-2-postcss"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_4-2-postcss"}},[a._v("#")]),a._v(" 4.2. PostCSS")]),a._v(" "),e("p",[a._v("报错：")]),a._v(" "),e("div",{staticClass:"language- extra-class"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[a._v("Syntax Error: Error: PostCSS plugin autoprefixer requires PostCSS 8.\n")])])]),e("p",[a._v("解决办法：")]),a._v(" "),e("div",{staticClass:"language-bash extra-class"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[e("span",{pre:!0,attrs:{class:"token function"}},[a._v("pnpm")]),a._v(" i autoprefixer@8.0.0 "),e("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-D")]),a._v("\n")])])]),e("div",{staticClass:"language-bash extra-class"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[e("span",{pre:!0,attrs:{class:"token function"}},[a._v("pnpm")]),a._v(" i webpack@4.46\n")])])]),e("h3",{attrs:{id:"_4-3-eslint解析vue组件失败"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_4-3-eslint解析vue组件失败"}},[a._v("#")]),a._v(" 4.3. eslint解析Vue组件失败")]),a._v(" "),e("p",[a._v("报错：")]),a._v(" "),e("div",{staticClass:"language- extra-class"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[a._v("invalid ecmaVersion\n")])])]),e("p",[a._v("解决办法：")]),a._v(" "),e("div",{staticClass:"language-js extra-class"},[e("pre",{pre:!0,attrs:{class:"language-js"}},[e("code",[e("span",{pre:!0,attrs:{class:"token comment"}},[a._v("// .eslintrc.js")]),a._v("\n"),e("span",{pre:!0,attrs:{class:"token literal-property property"}},[a._v("parserOptions")]),e("span",{pre:!0,attrs:{class:"token operator"}},[a._v(":")]),a._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("{")]),a._v("\n  "),e("span",{pre:!0,attrs:{class:"token literal-property property"}},[a._v("ecmaVersion")]),e("span",{pre:!0,attrs:{class:"token operator"}},[a._v(":")]),a._v(" "),e("span",{pre:!0,attrs:{class:"token number"}},[a._v("12")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(",")]),a._v("\n"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("}")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(",")]),a._v("\n")])])]),e("h3",{attrs:{id:"_4-4-eisdir-illegal-operation"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_4-4-eisdir-illegal-operation"}},[a._v("#")]),a._v(" 4.4. EISDIR: illegal operation")]),a._v(" "),e("p",[a._v("之前通过"),e("code",[a._v("npm")]),a._v("安装的包要删除之后，再执行"),e("code",[a._v("pnpm install")]),a._v("，否则会报错：")]),a._v(" "),e("div",{staticClass:"language- extra-class"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[a._v(" EISDIR  EISDIR: illegal operation on a directory, read\n \n")])])]),e("h3",{attrs:{id:"_4-5-miniprogram-ci"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_4-5-miniprogram-ci"}},[a._v("#")]),a._v(" 4.5. miniprogram-ci")]),a._v(" "),e("p",[a._v("小程序的CI工具用pnpm的时候有问题，问了相关开发人员，目前并不支持。")]),a._v(" "),e("p",[a._v("https://developers.weixin.qq.com/community/develop/doc/000e284b7d4bc09b194d0748356800")]),a._v(" "),e("h3",{attrs:{id:"_4-6-vue-loader版本"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_4-6-vue-loader版本"}},[a._v("#")]),a._v(" 4.6. vue-loader版本")]),a._v(" "),e("p",[e("code",[a._v("vue-loader")]),a._v("需要安装15版本，否则会报错：")]),a._v(" "),e("div",{staticClass:"language- extra-class"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[a._v("Syntax Error: Error: @vitejs/plugin-vue requires vue (>=3.2.13) or @vue/compiler-sfc to be present in the dependency tree.\n")])])]),e("p",[a._v("参考"),e("a",{attrs:{href:"https://stackoverflow.com/questions/64117281/error-vue-loader-requires-vue-compiler-sfc-to-be-present-in-the-dependency-tr",target:"_blank",rel:"noopener noreferrer"}},[a._v("这里"),e("OutboundLink")],1)]),a._v(" "),e("h3",{attrs:{id:"_4-7-file-type"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_4-7-file-type"}},[a._v("#")]),a._v(" 4.7. file-type")]),a._v(" "),e("p",[a._v("报错：")]),a._v(" "),e("div",{staticClass:"language- extra-class"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[a._v("Error [ERR_REQUIRE_ESM]: Must use import to load ES Module\n")])])]),e("p",[a._v("解决：")]),a._v(" "),e("div",{staticClass:"language-bash extra-class"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[e("span",{pre:!0,attrs:{class:"token function"}},[a._v("npm")]),a._v(" i file-type@16.5.3\n")])])]),e("p",[a._v("参考：https://github.com/sindresorhus/file-type/issues/535")]),a._v(" "),e("h3",{attrs:{id:"_4-8-vue-jest"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_4-8-vue-jest"}},[a._v("#")]),a._v(" 4.8. vue-jest")]),a._v(" "),e("p",[a._v("vue-jest@3.0.7版本安装失败，需要按照 vue-jest@4。")]),a._v(" "),e("h2",{attrs:{id:"_5-效果对比"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_5-效果对比"}},[a._v("#")]),a._v(" 5. 效果对比")]),a._v(" "),e("p",[a._v("其实我们的流水线已经做了优化，会对比"),e("code",[a._v("package.json")]),a._v("的依赖是否相同，若不同才执行"),e("code",[a._v("npm install")]),a._v("。")]),a._v(" "),e("p",[a._v("但问题是多个分支使用的是同一条流水线，而不同分支上的依赖很有可能不同，比如"),e("code",[a._v("press-ui")]),a._v("就处于持续迭代阶段，所以用"),e("code",[a._v("pnpm")]),a._v("优化还是有必要的。")]),a._v(" "),e("p",[a._v("全量安装的话，能节省"),e("code",[a._v("90s")]),a._v("左右，之前耗时：")]),a._v(" "),e("img",{attrs:{src:"https://mike-1255355338.cos.ap-guangzhou.myqcloud.com/article/2023/8/own_mike_c1021396214509dde6.png",width:"300"}}),a._v(" "),e("p",[a._v("现在：")]),a._v(" "),e("img",{attrs:{src:"https://mike-1255355338.cos.ap-guangzhou.myqcloud.com/article/2023/8/own_mike_7669daf7aa9fbb14dc.png",width:"300"}})])}),[],!1,null,null,null);e.default=r.exports}}]);