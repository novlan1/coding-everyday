(window.webpackJsonp=window.webpackJsonp||[]).push([[293],{903:function(t,a,s){"use strict";s.r(a);var e=s(42),n=Object(e.a)({},(function(){var t=this,a=t.$createElement,s=t._self._c||a;return s("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[s("ul",[s("li",[s("a",{attrs:{href:"#1-sequelize"}},[t._v("1. Sequelize")]),t._v(" "),s("ul",[s("li",[s("a",{attrs:{href:"#11-%E8%BF%9E%E6%8E%A5%E6%B1%A0"}},[t._v("1.1. 连接池")])]),t._v(" "),s("li",[s("a",{attrs:{href:"#12-%E5%B8%B8%E7%94%A8-api"}},[t._v("1.2. 常用 API")])]),t._v(" "),s("li",[s("a",{attrs:{href:"#13-sequelize-%E5%AE%9E%E7%8E%B0%E4%BA%8B%E5%8A%A1"}},[t._v("1.3. Sequelize 实现事务")])]),t._v(" "),s("li",[s("a",{attrs:{href:"#14-allowedmethods"}},[t._v("1.4. "),s("code",[t._v("allowedMethods")])])]),t._v(" "),s("li",[s("a",{attrs:{href:"#15-%E6%B3%A8%E6%84%8F%E4%BA%8B%E9%A1%B9"}},[t._v("1.5. 注意事项")])]),t._v(" "),s("li",[s("a",{attrs:{href:"#16-%E6%A8%A1%E7%B3%8A%E5%8C%B9%E9%85%8D"}},[t._v("1.6. 模糊匹配")])]),t._v(" "),s("li",[s("a",{attrs:{href:"#17-%E6%8E%92%E9%99%A4%E5%AD%97%E6%AE%B5"}},[t._v("1.7. 排除字段")])])])])]),t._v(" "),s("h3",{attrs:{id:"_1-sequelize"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_1-sequelize"}},[t._v("#")]),t._v(" 1. Sequelize")]),t._v(" "),s("p",[t._v("使用"),s("code",[t._v("wamp")]),t._v("，安装"),s("code",[t._v("mysql")]),t._v("简单，并且可以用"),s("code",[t._v("phpmyadmin")]),t._v("可视化数据库")]),t._v(" "),s("p",[t._v("在koa中用"),s("code",[t._v("sequelize")]),t._v("管理数据库，必须"),s("code",[t._v("npm install mysql2")]),t._v("，以及"),s("code",[t._v("npm install sequelize")])]),t._v(" "),s("p",[s("code",[t._v("sequelize")]),t._v("中事务 "),s("code",[t._v("transaction")]),t._v(" 须和"),s("code",[t._v("where")]),t._v("同级")]),t._v(" "),s("h4",{attrs:{id:"_1-1-连接池"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_1-1-连接池"}},[t._v("#")]),t._v(" 1.1. 连接池")]),t._v(" "),s("ul",[s("li",[t._v("如果池中有空闲连接可用，返回该连接。")]),t._v(" "),s("li",[t._v("如果池中连接都已用完，创建一个新连接添加到池中。")]),t._v(" "),s("li",[t._v("如果池中连接已达到最大连接数，请求进入等待队列直到有空闲连接可用。")])]),t._v(" "),s("p",[t._v("sequelize连接池，默认最小是0，最大是5。")]),t._v(" "),s("ul",[s("li",[s("code",[t._v("idle")]),t._v(" 参数是指闲置的连接超过多少毫秒被释放。")]),t._v(" "),s("li",[s("code",[t._v("acquire")]),t._v(" 参数是指在建立连接出错的时候，在抛出错误之前，池子会尝试建立连接的最大时间，重新连接成功就不抛出错误，不行才再抛。")])]),t._v(" "),s("h4",{attrs:{id:"_1-2-常用-api"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_1-2-常用-api"}},[t._v("#")]),t._v(" 1.2. 常用 API")]),t._v(" "),s("div",{staticClass:"language- extra-class"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[t._v("// 只选择相应属性\nModel.findAll( {\n  attributes: [ 'foo', 'bar' ]\n} );\n\n// 除开某些属性\nModel.findAll( {\n  attributes: { exclude: [ 'baz' ] }\n} );\n")])])]),s("div",{staticClass:"language-js extra-class"},[s("pre",{pre:!0,attrs:{class:"language-js"}},[s("code",[t._v("freezeTableName"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("true")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 默认false修改表名为复数，true不修改表名，与数据库表名同步")]),t._v("\n")])])]),s("p",[t._v("Mysql分组查询，如求三种类别图书的点赞数目")]),t._v(" "),s("div",{staticClass:"language-js extra-class"},[s("pre",{pre:!0,attrs:{class:"language-js"}},[s("code",[t._v("Favor"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("findAll")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  where"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    art_id"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n      "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("Op"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("in"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" ids\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n   "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n   group"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'art_id'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n   attributes"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'art_id'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("Sequelize"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("fn")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'COUNT'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'*'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'count'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n")])])]),s("p",[t._v("求数目总和是count，求字段总和如分数用sum，第二个参数是字段名称")]),t._v(" "),s("h4",{attrs:{id:"_1-3-sequelize-实现事务"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_1-3-sequelize-实现事务"}},[t._v("#")]),t._v(" 1.3. Sequelize 实现事务")]),t._v(" "),s("div",{staticClass:"language-js extra-class"},[s("pre",{pre:!0,attrs:{class:"language-js"}},[s("code",[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" db"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("transaction")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("async")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token parameter"}},[t._v("t")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=>")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("await")]),t._v(" Favor"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("create")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    art_id"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    type"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    uid\n  "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v(" transaction"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" t "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" art "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("await")]),t._v(" Art"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("getData")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("art_id"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" type"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("await")]),t._v(" art"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("increment")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'fav_nums'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v(" by"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" transaction"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" t "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n")])])]),s("p",[t._v("大写的"),s("code",[t._v("Favor")]),t._v("是表，小写的"),s("code",[t._v("favor")]),t._v("是表里的一条记录")]),t._v(" "),s("h4",{attrs:{id:"_1-4-allowedmethods"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_1-4-allowedmethods"}},[t._v("#")]),t._v(" 1.4. "),s("code",[t._v("allowedMethods")])]),t._v(" "),s("p",[s("code",[t._v(".allowedMethods")]),t._v("处理的业务是当所有路由中间件执行完成之后，若"),s("code",[t._v("ctx.status")]),t._v("为空或者404的时候，丰富"),s("code",[t._v("response")]),t._v("对象的"),s("code",[t._v("header")]),t._v("头。")]),t._v(" "),s("p",[t._v("如果只监听了 / 路由的 POST 方法，在浏览器中使用 GET 方法访问路由，koa 会自动设置一些 Header 并返回访问该路由的方法不被允许")]),t._v(" "),s("h4",{attrs:{id:"_1-5-注意事项"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_1-5-注意事项"}},[t._v("#")]),t._v(" 1.5. 注意事项")]),t._v(" "),s("ol",[s("li",[t._v("用户"),s("code",[t._v("id")]),t._v("不能通过参数传递，非常危险，应该通过"),s("code",[t._v("token")])]),t._v(" "),s("li",[t._v("避免循环查询数据库的方法是用"),s("code",[t._v("in")]),t._v("，即把查询的字段放到数组里。不可以用for循环，for循环不可控。")]),t._v(" "),s("li",[t._v("越主要的函数就应该越简洁，复杂逻辑要拆分。")]),t._v(" "),s("li",[t._v("A文件导入B文件，B文件导入A文件，即循环导入，会导致一个文件为"),s("code",[t._v("undefined")]),t._v("，不好排查，一个解决方法是"),s("strong",[t._v("在函数或类内部导入")])]),t._v(" "),s("li",[t._v("Model 中禁止使用构造函数")])]),t._v(" "),s("h4",{attrs:{id:"_1-6-模糊匹配"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_1-6-模糊匹配"}},[t._v("#")]),t._v(" 1.6. 模糊匹配")]),t._v(" "),s("p",[s("code",[t._v("%key%")]),t._v("，"),s("code",[t._v("mysql")]),t._v("不会使用索引，速度慢，而"),s("code",[t._v("key%")]),t._v("会使用索引，即用后面的百分号")]),t._v(" "),s("h4",{attrs:{id:"_1-7-排除字段"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_1-7-排除字段"}},[t._v("#")]),t._v(" 1.7. 排除字段")]),t._v(" "),s("ul",[s("li",[t._v("对象里面有"),s("code",[t._v("toJSON")]),t._v("方法的话，序列化结果就是"),s("code",[t._v("toJSON")]),t._v("函数返回的对象，可以用它来过滤字段。")]),t._v(" "),s("li",[t._v("在Model的原型链上添加"),s("code",[t._v("toJSON")]),t._v("方法，就不用每建立一个模型实例就手动添加"),s("code",[t._v("toJSON")]),t._v("方法了。并且添加"),s("code",[t._v("exclude")]),t._v("数组，可以简便的排除。")]),t._v(" "),s("li",[t._v("有个缺陷是只能用于"),s("code",[t._v("findOne")]),t._v("，如果是"),s("code",[t._v("findAll")]),t._v("需要在模型实例上，如"),s("code",[t._v("Comment.propotype.exclude = [‘id’]")]),t._v("进行排除。")])])])}),[],!1,null,null,null);a.default=n.exports}}]);