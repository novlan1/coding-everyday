(window.webpackJsonp=window.webpackJsonp||[]).push([[405],{678:function(t,s,a){"use strict";a.r(s);var n=a(14),r=Object(n.a)({},(function(){var t=this,s=t._self._c;return s("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[s("h2",{attrs:{id:"_1-工程适配"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_1-工程适配"}},[t._v("#")]),t._v(" 1. 工程适配")]),t._v(" "),s("p",[t._v("介绍下基于 uni-app 的小程序插件的设计思想、使用方法、适配工作、性能优化等。")]),t._v(" "),s("h3",{attrs:{id:"_1-1-设计原则"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_1-1-设计原则"}},[t._v("#")]),t._v(" 1.1. 设计原则")]),t._v(" "),s("p",[t._v("简单易用，一套代码既能独立发布，又能当小程序插件。独立发布包含了 uni-app 支持的所有端，包括 H5、微信小程序、QQ 小程序等。所以目标是 n+1 端，额外的 1 就是小程序插件。")]),t._v(" "),s("h3",{attrs:{id:"_1-2-使用方法"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_1-2-使用方法"}},[t._v("#")]),t._v(" 1.2. 使用方法")]),t._v(" "),s("p",[t._v("在环境变量 "),s("code",[t._v(".env.local")]),t._v(" 中新增 "),s("code",[t._v("VUE_APP_MP_PLUGIN = pluginRoot")]),t._v("。"),s("code",[t._v("pluginRoot")]),t._v(" 会被当作插件目录名称。")]),t._v(" "),s("p",[t._v("启动命令如下：")]),t._v(" "),s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 开发")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("npm")]),t._v(" run dev:mp-plugin \n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 发布")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("npm")]),t._v(" run build:mp-plugin\n")])])]),s("p",[t._v("然后在小程序开发者工具打开 "),s("code",[t._v("dist/dev/mp-weixin")]),t._v(" 或者 "),s("code",[t._v("dist/build/mp-weixin")]),t._v(" 进行调试、预览、上传等。")]),t._v(" "),s("h3",{attrs:{id:"_1-3-适配工作"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_1-3-适配工作"}},[t._v("#")]),t._v(" 1.3. 适配工作")]),t._v(" "),s("p",[t._v("包含以下几部分")]),t._v(" "),s("ol",[s("li",[t._v("命令兼容")]),t._v(" "),s("li",[t._v("playground 自动生成")]),t._v(" "),s("li",[t._v("路径修复")])]),t._v(" "),s("h4",{attrs:{id:"_1-3-1-命令兼容"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_1-3-1-命令兼容"}},[t._v("#")]),t._v(" 1.3.1. 命令兼容")]),t._v(" "),s("p",[t._v("默认 uni-app 脚手架不提供小程序插件编译命令，但提供了"),s("a",{attrs:{href:"https://zh.uniapp.dcloud.io/tutorial/mp-weixin-plugin-dev.html",target:"_blank",rel:"noopener noreferrer"}},[t._v("相关文档"),s("OutboundLink")],1),t._v("。")]),t._v(" "),s("p",[t._v("在结合我们项目过程中，踩了一些坑，这里记录下。主要是业务库为 monorepo 模式，由环境变量决定启动哪个子工程。为了启动小程序插件，以及兼容使用 npm，修改了 env.js 的逻辑，增加了环境变量中是否有小程序插件名称的判断，如果有则将其附在命令后面。")]),t._v(" "),s("div",{staticClass:"language-js extra-class"},[s("pre",{pre:!0,attrs:{class:"language-js"}},[s("code",[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" dotenv "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("require")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'dotenv'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" dotenvExpand "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("require")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'dotenv-expand'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v(" spawnSync "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("require")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'child_process'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" os "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("require")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'os'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" platform "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" os"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("platform")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" myEnv "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" dotenv"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("config")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("path")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'.env.local'")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\ndotenvExpand"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("expand")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("myEnv"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 执行真实的命令")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" realArgv "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" process"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("argv"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("slice")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("2")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("let")]),t._v(" command "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'npm'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("platform "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("===")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'win32'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  command "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'npm.cmd'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" otherArgv "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'run'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("...")]),t._v("realArgv"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 根据环境变量中是否有 VUE_APP_MP_PLUGIN 插件名称以及命令关键词，决定是否添加插件参数")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("process"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("env"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token constant"}},[t._v("VUE_APP_MP_PLUGIN")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("&&")]),t._v(" realArgv"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("===")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'mp-wx-plugin'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  otherArgv"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("push")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("...")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'--'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'--plugin'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" process"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("env"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token constant"}},[t._v("VUE_APP_MP_PLUGIN")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n"),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("spawnSync")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("command"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" otherArgv"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("stdio")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'inherit'")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])])]),s("p",[t._v("注意 "),s("code",[t._v("--plugin")]),t._v(" 前面必须有 "),s("code",[t._v("--")]),t._v("。")]),t._v(" "),s("p",[s("code",[t._v("package.json")]),t._v(" 增加命令如下：")]),t._v(" "),s("div",{staticClass:"language-json extra-class"},[s("pre",{pre:!0,attrs:{class:"language-json"}},[s("code",[s("span",{pre:!0,attrs:{class:"token property"}},[t._v('"dev:mp-plugin"')]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"npm run env dev:custom mp-wx-plugin --plugin"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token property"}},[t._v('"build:mp-plugin"')]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"npm run env build:custom mp-wx-plugin --plugin"')]),t._v("\n")])])]),s("p",[t._v("以及文档中提到的 uni-app 自定义命令")]),t._v(" "),s("div",{staticClass:"language-json extra-class"},[s("pre",{pre:!0,attrs:{class:"language-json"}},[s("code",[s("span",{pre:!0,attrs:{class:"token property"}},[t._v('"uni-app"')]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token property"}},[t._v('"scripts"')]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token property"}},[t._v('"mp-wx-plugin"')]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n      "),s("span",{pre:!0,attrs:{class:"token property"}},[t._v('"title"')]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"微信小程序插件"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n      "),s("span",{pre:!0,attrs:{class:"token property"}},[t._v('"env"')]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token property"}},[t._v('"UNI_PLATFORM"')]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"mp-weixin"')]),t._v("\n      "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n      "),s("span",{pre:!0,attrs:{class:"token property"}},[t._v('"define"')]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token property"}},[t._v('"MP-WX-PLUGIN"')]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("true")]),t._v("\n      "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),s("h4",{attrs:{id:"_1-3-2-playground-自动生成"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_1-3-2-playground-自动生成"}},[t._v("#")]),t._v(" 1.3.2. playground 自动生成")]),t._v(" "),s("p",[t._v("插件开发过程中需要一个小程序用来调试，具体可参见"),s("a",{attrs:{href:"https://developers.weixin.qq.com/miniprogram/dev/framework/plugin/development.html",target:"_blank",rel:"noopener noreferrer"}},[t._v("官方文档"),s("OutboundLink")],1),t._v("，我这里暂且称之为 "),s("code",[t._v("playground")]),t._v("。")]),t._v(" "),s("p",[t._v("默认情况下，在 uni-app 工程开发小程序插件时，每次都要将产物复制到另一个地方，然后用开发者工具打开，才能调试。这种效率过于低下，于是写了一个插件，可以在 dev 和 build 模式下都自动生成 "),s("code",[t._v("playground")]),t._v("。")]),t._v(" "),s("p",[t._v("原理是在模板的子工程目录下，提前放一个 "),s("code",[t._v("mp-plugin-public")]),t._v(" 的文件，里面包括 "),s("code",[t._v("doc/miniprogram/project.config.json")]),t._v(" 这些 "),s("code",[t._v("playground")]),t._v(" 的必要东西。然后在 "),s("code",[t._v("compiler.hooks.done")]),t._v(" 生命周期中（也可以用其他类似钩子），复制该目录到插件产物的上一层，然后打开该层目录，就可以自动调试了，无需手动拷贝。")]),t._v(" "),s("p",[t._v("为什么要将 "),s("code",[t._v("mp-plugin-public")]),t._v(" 放到子工程下呢，是考虑到每个子工程是单独的一个插件，有不同的名称、文档、示例。")]),t._v(" "),s("p",[t._v("为什么要命名为 "),s("code",[t._v("mp-plugin-public")]),t._v(" 呢，是将其类比成了 H5 下的 "),s("code",[t._v("public")]),t._v(" 目录，在打包过程中不会编译，只会复制。")]),t._v(" "),s("h4",{attrs:{id:"_1-3-3-路径修复"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_1-3-3-路径修复"}},[t._v("#")]),t._v(" 1.3.3. 路径修复")]),t._v(" "),s("p",[t._v("由于我们项目的结构有点深，"),s("code",[t._v("src/project/subProject")]),t._v("，以及引用了外层公共模块，比如 "),s("code",[t._v("src/component")]),t._v("，"),s("code",[t._v("src/local-logic")]),t._v(" 等。uni-app 在编译这种层级项目时，会生成错误的引用路径，需要编译插件修复。")]),t._v(" "),s("ol",[s("li",[t._v("引入公共模块错误")])]),t._v(" "),s("p",[t._v("举例来说，比如一个 "),s("code",[t._v("js")]),t._v(" 文件中引用了 "),s("code",[t._v("../common/runtime.js")]),t._v("，插件需要从当前文件往上找 "),s("code",[t._v("common/runtime.js")]),t._v(" 文件，找到了就返回正确的相对路径，并进行替换。替换结果可能为 "),s("code",[t._v("../../../common/runtime.js")]),t._v("。")]),t._v(" "),s("p",[t._v("另外，node_modules 下的引入路径也有问题，问题截图如下，也需要用类似方法修复。")]),t._v(" "),s("img",{attrs:{src:"https://mike-1255355338.cos.ap-guangzhou.myqcloud.com/article/2024/8/own_mike_59464c49f1f4d685d6.png",width:"600"}}),t._v(" "),s("ol",{attrs:{start:"2"}},[s("li",[t._v("使用了绝对路径")])]),t._v(" "),s("p",[t._v("参考下图，里面包含了错误的绝对路径，需要替换为正确的 "),s("code",[t._v("moduleId")]),t._v("。")]),t._v(" "),s("img",{attrs:{src:"https://mike-1255355338.cos.ap-guangzhou.myqcloud.com/article/2024/8/own_mike_c3b9a672306f979192.png",width:"600"}}),t._v(" "),s("ol",{attrs:{start:"3"}},[s("li",[t._v("getApp 找不到")])]),t._v(" "),s("p",[t._v("此外，低版本的 "),s("code",[t._v("uni-app")]),t._v(" 在编译小程序插件时候，还会使用 "),s("code",[t._v("getApp")]),t._v("，由于插件并不支持这个API，所以会报错，可以升级到最新版本解决。")]),t._v(" "),s("h2",{attrs:{id:"_2-ci"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_2-ci"}},[t._v("#")]),t._v(" 2. CI")]),t._v(" "),s("h2",{attrs:{id:"_3-性能"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_3-性能"}},[t._v("#")]),t._v(" 3. 性能")]),t._v(" "),s("p",[t._v("小程序插件本质和小程序一样，先从优化小程序包体积开始。")]),t._v(" "),s("h3",{attrs:{id:"_3-1-press-ui"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_3-1-press-ui"}},[t._v("#")]),t._v(" 3.1. press-ui")]),t._v(" "),s("p",[t._v("press-ui 是核心组件库，虽然它可以减少的空间并不大，但是会对所有项目产生影响。")]),t._v(" "),s("p",[t._v("优化前有 51KB，通过按需加载，条件编译去掉H5环境的方法等，缩小到了 43KB。")]),t._v(" "),s("img",{attrs:{src:"https://mike-1255355338.cos.ap-guangzhou.myqcloud.com/article/2024/8/own_mike_039c8690b63b5ed991.png",width:"500"}}),t._v(" "),s("img",{attrs:{src:"https://mike-1255355338.cos.ap-guangzhou.myqcloud.com/article/2024/8/own_mike_eead7e4ae02154b544.png",width:"500"}}),t._v(" "),s("h3",{attrs:{id:"_3-2-api-子仓库"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_3-2-api-子仓库"}},[t._v("#")]),t._v(" 3.2. api 子仓库")]),t._v(" "),s("p",[t._v("尽管 "),s("code",[t._v("src/api")]),t._v(" 已经做到了按需加载，只打包所需的接口，而不是所有接口，但依然有 25KB 的体积，这里一起优化下，直接使用调用 "),s("code",[t._v("post")]),t._v("，这部分体积可以直接降为 0。")]),t._v(" "),s("img",{attrs:{src:"https://mike-1255355338.cos.ap-guangzhou.myqcloud.com/article/2024/8/own_mike_5d6ebcc7a781562fa8.png",width:"500"}}),t._v(" "),s("h3",{attrs:{id:"_3-3-swiper"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_3-3-swiper"}},[t._v("#")]),t._v(" 3.3. swiper")]),t._v(" "),s("p",[t._v("业务使用了 "),s("code",[t._v("press-swiper")]),t._v("，来实现了一个较为美观的"),s("code",[t._v("swiper")]),t._v("。我研究了一番，直接用原生实现了。")]),t._v(" "),s("p",[t._v("核心原理如下：")]),t._v(" "),s("ol",[s("li",[t._v("通过 next-margin，previous-margin， 实现 swiper-item 不再撑满全屏")]),t._v(" "),s("li",[t._v("通过 getSystemInfo 获取 windowWidth，减去 wrapMargin、imageWidth 等值，动态计算 next-margin 和 previous-margin")]),t._v(" "),s("li",[t._v("监听 bindtransition 事件，获取 event.detail.dx，计算当前 swiper-item，并赋值，实现滑动切换 swiper")])]),t._v(" "),s("p",[t._v("这样优化后，发现切换 swiper-item 更加平滑，并直接省掉了 176KB 的大小。")]),t._v(" "),s("img",{attrs:{src:"https://mike-1255355338.cos.ap-guangzhou.myqcloud.com/article/2024/8/own_mike_540e35e2212afd174d.png",width:"500"}}),t._v(" "),s("img",{attrs:{src:"https://mike-1255355338.cos.ap-guangzhou.myqcloud.com/article/2024/8/own_mike_bdd6a42f8069e60029.png",width:"500"}}),t._v(" "),s("h3",{attrs:{id:"_3-4-uni-i18n"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_3-4-uni-i18n"}},[t._v("#")]),t._v(" 3.4. uni-i18n")]),t._v(" "),s("p",[t._v("这个库是 uni-app 内部用来实现国际化的，业务没有用到，写了一个 "),s("code",[t._v("loader")]),t._v(" 把它去掉了（只暴露了一个假的函数，返回最小需要的对象），可以省掉 7.5KB 的大小。")]),t._v(" "),s("img",{attrs:{src:"https://mike-1255355338.cos.ap-guangzhou.myqcloud.com/article/2024/8/own_mike_cc1bc0dc96109135bd.png",width:"500"}})])}),[],!1,null,null,null);s.default=r.exports}}]);