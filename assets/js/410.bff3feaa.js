(window.webpackJsonp=window.webpackJsonp||[]).push([[410],{683:function(t,s,a){"use strict";a.r(s);var n=a(14),e=Object(n.a)({},(function(){var t=this,s=t._self._c;return s("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[s("h2",{attrs:{id:"_1-工程适配"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_1-工程适配"}},[t._v("#")]),t._v(" 1. 工程适配")]),t._v(" "),s("p",[t._v("介绍下基于 uni-app 的小程序插件的设计思想、使用方法、适配工作、性能优化等。")]),t._v(" "),s("h3",{attrs:{id:"_1-1-设计原则"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_1-1-设计原则"}},[t._v("#")]),t._v(" 1.1. 设计原则")]),t._v(" "),s("p",[t._v("简单易用，一套代码既能独立发布，又能当小程序插件。独立发布包含了 uni-app 支持的所有端，包括 H5、微信小程序、QQ 小程序等。所以目标是 n+1 端，额外的 1 就是小程序插件。")]),t._v(" "),s("h3",{attrs:{id:"_1-2-使用方法"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_1-2-使用方法"}},[t._v("#")]),t._v(" 1.2. 使用方法")]),t._v(" "),s("p",[t._v("在环境变量 "),s("code",[t._v(".env.local")]),t._v(" 中新增 "),s("code",[t._v("VUE_APP_MP_PLUGIN = pluginRoot")]),t._v("。"),s("code",[t._v("pluginRoot")]),t._v(" 会被当作插件目录名称。")]),t._v(" "),s("p",[t._v("启动命令如下：")]),t._v(" "),s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 开发")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("npm")]),t._v(" run dev:mp-plugin \n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 发布")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("npm")]),t._v(" run build:mp-plugin\n")])])]),s("p",[t._v("然后在小程序开发者工具打开 "),s("code",[t._v("dist/dev/mp-weixin")]),t._v(" 或者 "),s("code",[t._v("dist/build/mp-weixin")]),t._v(" 进行调试、预览、上传等。")]),t._v(" "),s("h3",{attrs:{id:"_1-3-适配工作"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_1-3-适配工作"}},[t._v("#")]),t._v(" 1.3. 适配工作")]),t._v(" "),s("p",[t._v("包含以下几部分")]),t._v(" "),s("ol",[s("li",[t._v("命令兼容")]),t._v(" "),s("li",[t._v("playground 自动生成")]),t._v(" "),s("li",[t._v("路径修复")])]),t._v(" "),s("h4",{attrs:{id:"_1-3-1-命令兼容"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_1-3-1-命令兼容"}},[t._v("#")]),t._v(" 1.3.1. 命令兼容")]),t._v(" "),s("p",[t._v("默认 uni-app 脚手架不提供小程序插件编译命令，但提供了"),s("a",{attrs:{href:"https://zh.uniapp.dcloud.io/tutorial/mp-weixin-plugin-dev.html",target:"_blank",rel:"noopener noreferrer"}},[t._v("相关文档"),s("OutboundLink")],1),t._v("。")]),t._v(" "),s("p",[t._v("在结合我们项目过程中，踩了一些坑，这里记录下。主要是业务库为 monorepo 模式，由环境变量决定启动哪个子工程。为了启动小程序插件，以及兼容使用 npm，修改了 env.js 的逻辑，增加了环境变量中是否有小程序插件名称的判断，如果有则将其附在命令后面。")]),t._v(" "),s("div",{staticClass:"language-js extra-class"},[s("pre",{pre:!0,attrs:{class:"language-js"}},[s("code",[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" dotenv "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("require")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'dotenv'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" dotenvExpand "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("require")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'dotenv-expand'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v(" spawnSync "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("require")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'child_process'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" os "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("require")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'os'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" platform "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" os"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("platform")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" myEnv "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" dotenv"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("config")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("path")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'.env.local'")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\ndotenvExpand"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("expand")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("myEnv"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 执行真实的命令")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" realArgv "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" process"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("argv"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("slice")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("2")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("let")]),t._v(" command "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'npm'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("platform "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("===")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'win32'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  command "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'npm.cmd'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" otherArgv "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'run'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("...")]),t._v("realArgv"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 根据环境变量中是否有 VUE_APP_MP_PLUGIN 插件名称以及命令关键词，决定是否添加插件参数")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("process"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("env"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token constant"}},[t._v("VUE_APP_MP_PLUGIN")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("&&")]),t._v(" realArgv"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("===")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'mp-wx-plugin'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  otherArgv"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("push")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("...")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'--'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'--plugin'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" process"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("env"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token constant"}},[t._v("VUE_APP_MP_PLUGIN")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n"),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("spawnSync")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("command"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" otherArgv"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("stdio")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'inherit'")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])])]),s("p",[t._v("注意 "),s("code",[t._v("--plugin")]),t._v(" 前面必须有 "),s("code",[t._v("--")]),t._v("。")]),t._v(" "),s("p",[s("code",[t._v("package.json")]),t._v(" 增加命令如下：")]),t._v(" "),s("div",{staticClass:"language-json extra-class"},[s("pre",{pre:!0,attrs:{class:"language-json"}},[s("code",[s("span",{pre:!0,attrs:{class:"token property"}},[t._v('"dev:mp-plugin"')]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"npm run env dev:custom mp-wx-plugin --plugin"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token property"}},[t._v('"build:mp-plugin"')]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"npm run env build:custom mp-wx-plugin --plugin"')]),t._v("\n")])])]),s("p",[t._v("以及文档中提到的 uni-app 自定义命令")]),t._v(" "),s("div",{staticClass:"language-json extra-class"},[s("pre",{pre:!0,attrs:{class:"language-json"}},[s("code",[s("span",{pre:!0,attrs:{class:"token property"}},[t._v('"uni-app"')]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token property"}},[t._v('"scripts"')]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token property"}},[t._v('"mp-wx-plugin"')]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n      "),s("span",{pre:!0,attrs:{class:"token property"}},[t._v('"title"')]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"微信小程序插件"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n      "),s("span",{pre:!0,attrs:{class:"token property"}},[t._v('"env"')]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token property"}},[t._v('"UNI_PLATFORM"')]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"mp-weixin"')]),t._v("\n      "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n      "),s("span",{pre:!0,attrs:{class:"token property"}},[t._v('"define"')]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token property"}},[t._v('"MP-WX-PLUGIN"')]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("true")]),t._v("\n      "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),s("h4",{attrs:{id:"_1-3-2-playground-自动生成"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_1-3-2-playground-自动生成"}},[t._v("#")]),t._v(" 1.3.2. playground 自动生成")]),t._v(" "),s("p",[t._v("插件开发过程中需要一个小程序用来调试，具体可参见"),s("a",{attrs:{href:"https://developers.weixin.qq.com/miniprogram/dev/framework/plugin/development.html",target:"_blank",rel:"noopener noreferrer"}},[t._v("官方文档"),s("OutboundLink")],1),t._v("，我这里暂且称之为 "),s("code",[t._v("playground")]),t._v("。")]),t._v(" "),s("p",[t._v("默认情况下，在 uni-app 工程开发小程序插件时，每次都要将产物复制到另一个地方，然后用开发者工具打开，才能调试。这种效率过于低下，于是写了一个插件，可以在 dev 和 build 模式下都自动生成 "),s("code",[t._v("playground")]),t._v("。")]),t._v(" "),s("p",[t._v("原理是在模板的子工程目录下，提前放一个 "),s("code",[t._v("mp-plugin-public")]),t._v(" 的文件，里面包括 "),s("code",[t._v("doc/miniprogram/project.config.json")]),t._v(" 这些 "),s("code",[t._v("playground")]),t._v(" 的必要东西。然后在 "),s("code",[t._v("compiler.hooks.done")]),t._v(" 生命周期中（也可以用其他类似钩子），复制该目录到插件产物的上一层，然后打开该层目录，就可以自动调试了，无需手动拷贝。")]),t._v(" "),s("p",[t._v("为什么要将 "),s("code",[t._v("mp-plugin-public")]),t._v(" 放到子工程下呢，是考虑到每个子工程是单独的一个插件，有不同的名称、文档、示例。")]),t._v(" "),s("p",[t._v("为什么要命名为 "),s("code",[t._v("mp-plugin-public")]),t._v(" 呢，是将其类比成了 H5 下的 "),s("code",[t._v("public")]),t._v(" 目录，在打包过程中不会编译，只会复制。")]),t._v(" "),s("h4",{attrs:{id:"_1-3-3-路径修复"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_1-3-3-路径修复"}},[t._v("#")]),t._v(" 1.3.3. 路径修复")]),t._v(" "),s("p",[t._v("由于我们项目的结构有点深，"),s("code",[t._v("src/project/subProject")]),t._v("，以及引用了外层公共模块，比如 "),s("code",[t._v("src/component")]),t._v("，"),s("code",[t._v("src/local-logic")]),t._v(" 等。uni-app 在编译这种层级项目时，会生成错误的引用路径，需要编译插件修复。")]),t._v(" "),s("ol",[s("li",[t._v("引入公共模块错误")])]),t._v(" "),s("p",[t._v("举例来说，比如一个 "),s("code",[t._v("js")]),t._v(" 文件中引用了 "),s("code",[t._v("../common/runtime.js")]),t._v("，插件需要从当前文件往上找 "),s("code",[t._v("common/runtime.js")]),t._v(" 文件，找到了就返回正确的相对路径，并进行替换。替换结果可能为 "),s("code",[t._v("../../../common/runtime.js")]),t._v("。")]),t._v(" "),s("p",[t._v("另外，node_modules 下的引入路径也有问题，问题截图如下，也需要用类似方法修复。")]),t._v(" "),s("img",{attrs:{src:"https://mike-1255355338.cos.ap-guangzhou.myqcloud.com/article/2024/8/own_mike_59464c49f1f4d685d6.png",width:"600"}}),t._v(" "),s("ol",{attrs:{start:"2"}},[s("li",[t._v("使用了绝对路径")])]),t._v(" "),s("p",[t._v("参考下图，里面包含了错误的绝对路径，需要替换为正确的 "),s("code",[t._v("moduleId")]),t._v("。")]),t._v(" "),s("img",{attrs:{src:"https://mike-1255355338.cos.ap-guangzhou.myqcloud.com/article/2024/8/own_mike_c3b9a672306f979192.png",width:"600"}}),t._v(" "),s("ol",{attrs:{start:"3"}},[s("li",[t._v("getApp 找不到")])]),t._v(" "),s("p",[t._v("此外，低版本的 "),s("code",[t._v("uni-app")]),t._v(" 在编译小程序插件时候，还会使用 "),s("code",[t._v("getApp")]),t._v("，由于插件并不支持这个API，所以会报错，可以升级到最新版本解决。")]),t._v(" "),s("h2",{attrs:{id:"_2-性能"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_2-性能"}},[t._v("#")]),t._v(" 2. 性能")]),t._v(" "),s("p",[t._v("小程序插件本质和小程序一样，先从优化小程序包体积开始。")]),t._v(" "),s("p",[t._v("先贴下最开始的包体积，方便对比。最开始总包 1.92MB。")]),t._v(" "),s("img",{attrs:{src:"https://mike-1255355338.cos.ap-guangzhou.myqcloud.com/article/2024/8/own_mike_bd34e66ccf679453ac.png",width:"500"}}),t._v(" "),s("h3",{attrs:{id:"_2-1-分类"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_2-1-分类"}},[t._v("#")]),t._v(" 2.1. 分类")]),t._v(" "),s("p",[t._v("小程序包可以分为公共部分和业务部分，公共部分又可分为第三方的和我们项目组的。")]),t._v(" "),s("p",[t._v("第三方公共包括：")]),t._v(" "),s("ul",[s("li",[t._v("uni-app 相关\n"),s("ul",[s("li",[t._v("uni-mp-weixin/dist/index.js")]),t._v(" "),s("li",[t._v("vue-cli-plugin-uni/mp-runtime.esm.js")]),t._v(" "),s("li",[t._v("uni-i18n")])])]),t._v(" "),s("li",[t._v("Press UI")]),t._v(" "),s("li",[t._v("crypto、md5")]),t._v(" "),s("li",[t._v("weapp-qrcode")]),t._v(" "),s("li",[t._v("qs")]),t._v(" "),s("li",[t._v("其他")])]),t._v(" "),s("p",[t._v("项目组公共包括：")]),t._v(" "),s("ul",[s("li",[t._v("pmd-npm\n"),s("ul",[s("li",[t._v("startApp")]),t._v(" "),s("li",[t._v("report")]),t._v(" "),s("li",[t._v("login")]),t._v(" "),s("li",[t._v("tools")]),t._v(" "),s("li",[t._v("...")])])]),t._v(" "),s("li",[t._v("press-plus")]),t._v(" "),s("li",[t._v("src/api")])]),t._v(" "),s("p",[t._v("业务部分就是剩下的了，包括所有业务组件和业务逻辑。")]),t._v(" "),s("p",[t._v("优化不同部分内容的影响是不同的。对第三方库的优化，对影响所有使用它的项目，是影响力最大的。对项目组公共部分的优化，会影响项目组所有业务。对业务的优化，就只会影响当前业务了。")]),t._v(" "),s("p",[t._v("就这个项目而言，三方库体积并不大，最大的是业务和项目组公共部分。")]),t._v(" "),s("h3",{attrs:{id:"_2-2-减包思想"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_2-2-减包思想"}},[t._v("#")]),t._v(" 2.2. 减包思想")]),t._v(" "),s("p",[t._v("减包主要分下面几种情况：")]),t._v(" "),s("ul",[s("li",[t._v("完全运行不到的代码")]),t._v(" "),s("li",[t._v("重复代码")]),t._v(" "),s("li",[t._v("可以用更简单方式替换的代码")])]),t._v(" "),s("p",[t._v("完全运行不到的代码，比如 "),s("code",[t._v("uni-i18n")]),t._v(" 的大部分逻辑、缺少条件编译的 H5 逻辑。")]),t._v(" "),s("p",[t._v("重复代码常见的有两段逻辑相似，或者引入了同一个包的两个版本。")]),t._v(" "),s("p",[t._v("可以用更简单方式替换的代码，比如用小程序原生上报代替 "),s("code",[t._v("aegis")]),t._v("、用原生 "),s("code",[t._v("swiper")]),t._v(" 代替 "),s("code",[t._v("press-swiper")]),t._v("、自己写 "),s("code",[t._v("btoa")]),t._v(" 代替 "),s("code",[t._v("js-base64")]),t._v(" 中的 "),s("code",[t._v("encode")]),t._v(" 等。")]),t._v(" "),s("h2",{attrs:{id:"_3-优化点"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_3-优化点"}},[t._v("#")]),t._v(" 3. 优化点")]),t._v(" "),s("p",[t._v("下面每条优化我都给出对比效果，以及其他项目也想要使用时，可以采用的方法。")]),t._v(" "),s("h3",{attrs:{id:"_3-1-press-ui"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_3-1-press-ui"}},[t._v("#")]),t._v(" 3.1. press-ui")]),t._v(" "),s("p",[t._v("press-ui 是核心组件库，虽然它可以减少的空间并不大，但是会对所有项目产生影响。")]),t._v(" "),s("p",[t._v("优化前有 51KB，通过按需加载，条件编译去掉H5环境的方法等，缩小到了 43KB。")]),t._v(" "),s("img",{attrs:{src:"https://mike-1255355338.cos.ap-guangzhou.myqcloud.com/article/2024/8/own_mike_039c8690b63b5ed991.png",width:"500"}}),t._v(" "),s("img",{attrs:{src:"https://mike-1255355338.cos.ap-guangzhou.myqcloud.com/article/2024/8/own_mike_eead7e4ae02154b544.png",width:"500"}}),t._v(" "),s("p",[t._v("又发现打包的 CSS 中有一些没有用到的公共样式，比如 ellipsis, hairline 等，通过按需引入，又减少了 20KB。")]),t._v(" "),s("img",{attrs:{src:"https://mike-1255355338.cos.ap-guangzhou.myqcloud.com/article/2024/8/own_mike_7d36e4a17dcd3a6e7d.png",width:"500"}}),t._v(" "),s("img",{attrs:{src:"https://mike-1255355338.cos.ap-guangzhou.myqcloud.com/article/2024/8/own_mike_90a1a4de5db1f3e04e.png",width:"500"}}),t._v(" "),s("img",{attrs:{src:"https://mike-1255355338.cos.ap-guangzhou.myqcloud.com/article/2024/8/own_mike_738d650545621823df.png",width:"500"}}),t._v(" "),s("p",[t._v("其他项目想要用的话，直接升级最新版本 "),s("code",[t._v("press-ui")]),t._v(" 即可。")]),t._v(" "),s("p",[t._v("另外 "),s("code",[t._v("press-icon-plus")]),t._v(" 打包了所有的图标，但实际只用了其中一两个，这里可以用 "),s("code",[t._v("postcss")]),t._v(" 插件将多余的图标去掉，省掉 11KB。")]),t._v(" "),s("img",{attrs:{src:"https://mike-1255355338.cos.ap-guangzhou.myqcloud.com/article/2024/8/own_mike_a93e2ff3f43d41ae1e.png",width:"500"}}),t._v(" "),s("p",[t._v("其他项目想要用的话，可以使用 "),s("code",[t._v("plugin-light")]),t._v(" 中的 "),s("code",[t._v("remove-selector")]),t._v(" 插件。")]),t._v(" "),s("h3",{attrs:{id:"_3-2-api-子仓库"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_3-2-api-子仓库"}},[t._v("#")]),t._v(" 3.2. api 子仓库")]),t._v(" "),s("p",[t._v("尽管 "),s("code",[t._v("src/api")]),t._v(" 已经做到了按需加载，只打包所需的接口，而不是所有接口，但依然有 25KB 的体积，这里一起优化下，直接使用调用 "),s("code",[t._v("post")]),t._v("，这部分体积可以直接降为 0。")]),t._v(" "),s("img",{attrs:{src:"https://mike-1255355338.cos.ap-guangzhou.myqcloud.com/article/2024/8/own_mike_5d6ebcc7a781562fa8.png",width:"500"}}),t._v(" "),s("p",[t._v("其他项目想要使用的话，需要自己修改代码。")]),t._v(" "),s("p",[t._v("--- 分割线")]),t._v(" "),s("p",[t._v("后面想了一下，"),s("code",[t._v("src/api")]),t._v(" 这个库还是还有必要的，typescript 类型检查不可少。分析了一下为什么能占这么多体积，发现其引用了并非是按需加载的包，而是 "),s("code",[t._v("all-in-one")]),t._v(" 的文件，而且即使是按需加载的包也有很多重复方法，这里我提取了一下。")]),t._v(" "),s("img",{attrs:{src:"https://mike-1255355338.cos.ap-guangzhou.myqcloud.com/article/2024/8/own_mike_46c11f85cfb1f84211.png",width:"500"}}),t._v(" "),s("h3",{attrs:{id:"_3-3-swiper"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_3-3-swiper"}},[t._v("#")]),t._v(" 3.3. swiper")]),t._v(" "),s("p",[t._v("业务使用了 "),s("code",[t._v("press-swiper")]),t._v("，来实现了一个较为美观的"),s("code",[t._v("swiper")]),t._v("。我研究了一番，直接用原生实现了。")]),t._v(" "),s("p",[t._v("核心原理如下：")]),t._v(" "),s("ol",[s("li",[t._v("通过 "),s("code",[t._v("next-margin")]),t._v("，"),s("code",[t._v("previous-margin")]),t._v("， 实现 "),s("code",[t._v("swiper-item")]),t._v(" 不再撑满全屏")]),t._v(" "),s("li",[t._v("通过 "),s("code",[t._v("getSystemInfo")]),t._v(" 获取 "),s("code",[t._v("windowWidth")]),t._v("，减去 "),s("code",[t._v("wrapMargin")]),t._v("、"),s("code",[t._v("imageWidth")]),t._v(" 等值，动态计算 "),s("code",[t._v("next-margin")]),t._v(" 和 "),s("code",[t._v("previous-margin")])]),t._v(" "),s("li",[t._v("监听 "),s("code",[t._v("transition")]),t._v(" 事件，获取 "),s("code",[t._v("event.detail.dx")]),t._v("，计算当前"),s("code",[t._v("swiper-item")]),t._v("，并赋值，实现滑动切换 "),s("code",[t._v("swiper")])])]),t._v(" "),s("p",[t._v("贴一下核心代码，备忘下。")]),t._v(" "),s("div",{staticClass:"language-html extra-class"},[s("pre",{pre:!0,attrs:{class:"language-html"}},[s("code",[s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("\x3c!-- #ifndef H5 --\x3e")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),t._v("swiper")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token attr-name"}},[t._v("v-if")]),s("span",{pre:!0,attrs:{class:"token attr-value"}},[s("span",{pre:!0,attrs:{class:"token punctuation attr-equals"}},[t._v("=")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v('"')]),t._v("mSwiperInit"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v('"')])]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token attr-name"}},[t._v("ref")]),s("span",{pre:!0,attrs:{class:"token attr-value"}},[s("span",{pre:!0,attrs:{class:"token punctuation attr-equals"}},[t._v("=")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v('"')]),t._v("zSwiper"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v('"')])]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token attr-name"}},[t._v("v-model")]),s("span",{pre:!0,attrs:{class:"token attr-value"}},[s("span",{pre:!0,attrs:{class:"token punctuation attr-equals"}},[t._v("=")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v('"')]),t._v("mGameTaskList"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v('"')])]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token attr-name"}},[t._v(":options")]),s("span",{pre:!0,attrs:{class:"token attr-value"}},[s("span",{pre:!0,attrs:{class:"token punctuation attr-equals"}},[t._v("=")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v('"')]),t._v("ZSwiperOptions"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v('"')])]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token attr-name"}},[t._v(":current")]),s("span",{pre:!0,attrs:{class:"token attr-value"}},[s("span",{pre:!0,attrs:{class:"token punctuation attr-equals"}},[t._v("=")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v('"')]),t._v("mCurrentSelectedTab"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v('"')])]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token attr-name"}},[t._v(":next-margin")]),s("span",{pre:!0,attrs:{class:"token attr-value"}},[s("span",{pre:!0,attrs:{class:"token punctuation attr-equals"}},[t._v("=")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v('"')]),t._v("nextMargin"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v('"')])]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token attr-name"}},[t._v(":previous-margin")]),s("span",{pre:!0,attrs:{class:"token attr-value"}},[s("span",{pre:!0,attrs:{class:"token punctuation attr-equals"}},[t._v("=")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v('"')]),t._v("nextMargin"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v('"')])]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token attr-name"}},[t._v("@transition")]),s("span",{pre:!0,attrs:{class:"token attr-value"}},[s("span",{pre:!0,attrs:{class:"token punctuation attr-equals"}},[t._v("=")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v('"')]),t._v("onSwiperTransition"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v('"')])]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token attr-name"}},[t._v("@animationfinish")]),s("span",{pre:!0,attrs:{class:"token attr-value"}},[s("span",{pre:!0,attrs:{class:"token punctuation attr-equals"}},[t._v("=")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v('"')]),t._v("onSwiperTransitionFInish"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v('"')])]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token attr-name"}},[t._v("@touchstart")]),s("span",{pre:!0,attrs:{class:"token attr-value"}},[s("span",{pre:!0,attrs:{class:"token punctuation attr-equals"}},[t._v("=")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v('"')]),t._v("onTouchStart"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v('"')])]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token attr-name"}},[t._v("@touchmove")]),s("span",{pre:!0,attrs:{class:"token attr-value"}},[s("span",{pre:!0,attrs:{class:"token punctuation attr-equals"}},[t._v("=")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v('"')]),t._v("onTouchMove"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v('"')])]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token attr-name"}},[t._v("@touchend")]),s("span",{pre:!0,attrs:{class:"token attr-value"}},[s("span",{pre:!0,attrs:{class:"token punctuation attr-equals"}},[t._v("=")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v('"')]),t._v("onTouchEnd"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v('"')])]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),t._v("swiper-item")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token attr-name"}},[t._v("v-for")]),s("span",{pre:!0,attrs:{class:"token attr-value"}},[s("span",{pre:!0,attrs:{class:"token punctuation attr-equals"}},[t._v("=")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v('"')]),t._v("(item,index) in mGameTaskList"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v('"')])]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token attr-name"}},[t._v(":key")]),s("span",{pre:!0,attrs:{class:"token attr-value"}},[s("span",{pre:!0,attrs:{class:"token punctuation attr-equals"}},[t._v("=")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v('"')]),t._v("index"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v('"')])]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),t._v("div")]),t._v("\n      "),s("span",{pre:!0,attrs:{class:"token attr-name"}},[t._v("class")]),s("span",{pre:!0,attrs:{class:"token attr-value"}},[s("span",{pre:!0,attrs:{class:"token punctuation attr-equals"}},[t._v("=")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v('"')]),t._v("task-type-item"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v('"')])]),t._v("\n      "),s("span",{pre:!0,attrs:{class:"token attr-name"}},[t._v(":class")]),s("span",{pre:!0,attrs:{class:"token attr-value"}},[s("span",{pre:!0,attrs:{class:"token punctuation attr-equals"}},[t._v("=")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v('"')]),t._v("{\n        'task-type-item--active': mCurrentSelectedTab === index\n      }"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v('"')])]),t._v("\n      "),s("span",{pre:!0,attrs:{class:"token attr-name"}},[t._v("@click.stop")]),s("span",{pre:!0,attrs:{class:"token attr-value"}},[s("span",{pre:!0,attrs:{class:"token punctuation attr-equals"}},[t._v("=")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v('"')]),t._v("changeSelectedGame(index, true)"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v('"')])]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("\n      "),s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),t._v("img")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token attr-name"}},[t._v("class")]),s("span",{pre:!0,attrs:{class:"token attr-value"}},[s("span",{pre:!0,attrs:{class:"token punctuation attr-equals"}},[t._v("=")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v('"')]),t._v("task-type-img"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v('"')])]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token attr-name"}},[t._v(":src")]),s("span",{pre:!0,attrs:{class:"token attr-value"}},[s("span",{pre:!0,attrs:{class:"token punctuation attr-equals"}},[t._v("=")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v('"')]),t._v("tinyImage(item.icon)"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v('"')])]),t._v("\n      "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("</")]),t._v("div")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("</")]),t._v("swiper-item")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("</")]),t._v("swiper")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("\x3c!-- #endif --\x3e")]),t._v("\n")])])]),s("div",{staticClass:"language-ts extra-class"},[s("pre",{pre:!0,attrs:{class:"language-ts"}},[s("code",[t._v("methods"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("onSwiperTransition")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("e"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v(" dx "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" e"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("detail"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("!")]),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("this")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("manualMoving"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    movingDx "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" dx"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("onSwiperTransitionFInish")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("onTouchStart")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("this")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("clearTimer")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("this")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("manualMoving "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("true")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("this")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("movingCurrent "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("this")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("mCurrentSelectedTab"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    movingDx "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("onTouchMove")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("onTouchEnd")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("this")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("manualMoving "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("false")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("let")]),t._v(" current"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("movingDx "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n      current "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" Math"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("min")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("this")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("movingCurrent "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("+")]),t._v(" Math"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("round")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("movingDx "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("60")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("this")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("mGameTaskList"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("length "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("else")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n      current "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" Math"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("max")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("this")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("movingCurrent "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("+")]),t._v("  Math"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("round")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("movingDx "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("60")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("this")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("changeSelectedGame")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("current"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("this")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("startTimer")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("getSwiperDomWidth")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" that "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("this")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("new")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[s("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("Promise")])]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("resolve"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=>")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n      wx"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("getSystemInfo")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("success")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("res"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n          "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" clientWidth "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" res"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("windowWidth"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n          "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" ratio "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("750")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v(" clientWidth"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n          "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" wrapWidth "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" clientWidth "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v(" Math"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("floor")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("32")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v(" ratio"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("2")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v(" Math"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("floor")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("20")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v(" ratio"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("2")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n          "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" nextMargin "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("wrapWidth "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v(" Math"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("floor")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("104")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v(" ratio"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v(" Math"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("floor")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("16")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v(" ratio"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("2")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("2")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n          that"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("nextMargin "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token template-string"}},[s("span",{pre:!0,attrs:{class:"token template-punctuation string"}},[t._v("`")]),s("span",{pre:!0,attrs:{class:"token interpolation"}},[s("span",{pre:!0,attrs:{class:"token interpolation-punctuation punctuation"}},[t._v("${")]),t._v("nextMargin"),s("span",{pre:!0,attrs:{class:"token interpolation-punctuation punctuation"}},[t._v("}")])]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("px")]),s("span",{pre:!0,attrs:{class:"token template-punctuation string"}},[t._v("`")])]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n          "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("resolve")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n      "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),s("p",[t._v("这样优化后，发现切换 "),s("code",[t._v("swiper-item")]),t._v(" 更加平滑，并直接省掉了 "),s("code",[t._v("176KB")]),t._v(" 的大小。")]),t._v(" "),s("img",{attrs:{src:"https://mike-1255355338.cos.ap-guangzhou.myqcloud.com/article/2024/8/own_mike_540e35e2212afd174d.png",width:"500"}}),t._v(" "),s("img",{attrs:{src:"https://mike-1255355338.cos.ap-guangzhou.myqcloud.com/article/2024/8/own_mike_bdd6a42f8069e60029.png",width:"500"}}),t._v(" "),s("p",[t._v("效果如下：")]),t._v(" "),s("img",{attrs:{src:"https://mike-1255355338.cos.ap-guangzhou.myqcloud.com/article/2024/8/own_mike_2014d9c6eb9f6f272b.gif",width:"375"}}),t._v(" "),s("p",[t._v("其他项目想要使用的话，可以使用封装好的方法。")]),t._v(" "),s("h3",{attrs:{id:"_3-4-uni-i18n"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_3-4-uni-i18n"}},[t._v("#")]),t._v(" 3.4. uni-i18n")]),t._v(" "),s("p",[t._v("这个库是 uni-app 内部用来实现国际化的，业务没有用到，写了一个 "),s("code",[t._v("loader")]),t._v(" 把它去掉了（只暴露了一个假的函数，返回最小需要的对象），可以省掉 7.5KB 的大小。")]),t._v(" "),s("img",{attrs:{src:"https://mike-1255355338.cos.ap-guangzhou.myqcloud.com/article/2024/8/own_mike_cc1bc0dc96109135bd.png",width:"500"}}),t._v(" "),s("p",[t._v("其他项目想要使用的话，可以给 "),s("code",[t._v("plugin-light")]),t._v(" 的 "),s("code",[t._v("getUniVueConfig")]),t._v(" 传入")]),t._v(" "),s("div",{staticClass:"language-ts extra-class"},[s("pre",{pre:!0,attrs:{class:"language-ts"}},[s("code",[t._v("replaceLibraryLoaderOptions"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  replaceContentList"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n      path"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'uni-i18n.es.js'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n      "),s("span",{pre:!0,attrs:{class:"token function-variable function"}},[t._v("content")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=>")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'export function initVueI18n() {return {t:()=>{}}}'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n")])])]),s("p",[t._v("也可以直接使用 "),s("code",[t._v("replaceLibraryLoader")]),t._v("，传入相同参数。")]),t._v(" "),s("h3",{attrs:{id:"_3-5-js-base64"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_3-5-js-base64"}},[t._v("#")]),t._v(" 3.5. js-base64")]),t._v(" "),s("p",[t._v("业务主要用到了这个库的 "),s("code",[t._v("encode")]),t._v(" 方法，其实就是 "),s("code",[t._v("window.btoa")]),t._v("，这个自己实现下小程序端的就行了。")]),t._v(" "),s("p",[t._v("从引用关系看，"),s("code",[t._v("js-base64")]),t._v(" 引入了 "),s("code",[t._v("buffer.js")]),t._v("，"),s("code",[t._v("buffer.js")]),t._v(" 又引入了其他的工具函数，所以去掉 "),s("code",[t._v("js-base64")]),t._v(" 可以优化出比预期较多的体积，实际大概 25.89KB。")]),t._v(" "),s("p",[t._v("之前 JS 总体积：")]),t._v(" "),s("img",{attrs:{src:"https://mike-1255355338.cos.ap-guangzhou.myqcloud.com/article/2024/8/own_mike_1aa7454104cc5e6542.png",width:"500"}}),t._v(" "),s("p",[t._v("去掉 "),s("code",[t._v("js-base64")]),t._v(" 后的 JS 总体积：")]),t._v(" "),s("img",{attrs:{src:"https://mike-1255355338.cos.ap-guangzhou.myqcloud.com/article/2024/8/own_mike_4c73a0420f2de42cc5.png",width:"500"}}),t._v(" "),s("p",[s("code",[t._v("buffer.js")]),t._v(" 体积：")]),t._v(" "),s("img",{attrs:{src:"https://mike-1255355338.cos.ap-guangzhou.myqcloud.com/article/2024/8/own_mike_02514049b673f9a00c.png",width:"500"}}),t._v(" "),s("p",[s("code",[t._v("buffer.js")]),t._v(" 引用的子模块：")]),t._v(" "),s("img",{attrs:{src:"https://mike-1255355338.cos.ap-guangzhou.myqcloud.com/article/2024/8/own_mike_c58b5ef0d8ad6031f1.png",width:"500"}}),t._v(" "),s("p",[t._v("其他项目想要使用的话，手动替换 "),s("code",[t._v("encode/decode")]),t._v(" 到 "),s("code",[t._v("t-comm")]),t._v(" 或者 "),s("code",[t._v("pmd-tools")]),t._v(" 中的方法。")]),t._v(" "),s("h3",{attrs:{id:"_3-6-pmd"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_3-6-pmd"}},[t._v("#")]),t._v(" 3.6. pmd")]),t._v(" "),s("h4",{attrs:{id:"_3-6-1-pmd-vue"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_3-6-1-pmd-vue"}},[t._v("#")]),t._v(" 3.6.1. pmd-vue")]),t._v(" "),s("ul",[s("li",[s("p",[s("code",[t._v("launchapp/base.ts")]),t._v(" 中都是 H5 的拉起方法，用条件编译去掉")])]),t._v(" "),s("li",[s("p",[t._v("去掉 "),s("code",[t._v("initReport")]),t._v("，因为没有 "),s("code",[t._v("aegis")]),t._v(" 了，这个引用也就没意义了")])]),t._v(" "),s("li",[s("p",[t._v("去掉 "),s("code",[t._v("initFilter")]),t._v("，没有用到")])]),t._v(" "),s("li",[s("p",[t._v("去掉 "),s("code",[t._v("initMixin")]),t._v("，使用工具方法")])])]),t._v(" "),s("h4",{attrs:{id:"_3-6-2-pmd-tools"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_3-6-2-pmd-tools"}},[t._v("#")]),t._v(" 3.6.2. pmd-tools")]),t._v(" "),s("ul",[s("li",[s("p",[s("code",[t._v("env/user-agent.ts")]),t._v(" 小程序中用不到，用关键词编译方法去掉")])]),t._v(" "),s("li",[s("p",[s("code",[t._v("validate/index.ts")]),t._v(" 中只用到了 "),s("code",[t._v("getType")]),t._v(" 方法，把它单独拿出来引用")])]),t._v(" "),s("li",[s("p",[s("code",[t._v("dialog-displayer/index.ts")]),t._v(" 小程序中用不到，用关键词编译方法去掉")])]),t._v(" "),s("li",[s("p",[s("code",[t._v("time")]),t._v(" 模块太大，用到的其中几个方法，把它们单独提出来，单独引用")])])]),t._v(" "),s("h4",{attrs:{id:"_3-6-3-pmd-report"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_3-6-3-pmd-report"}},[t._v("#")]),t._v(" 3.6.3. pmd-report")]),t._v(" "),s("p",[s("code",[t._v("tcss")]),t._v(" 已废弃，直接去掉")]),t._v(" "),s("p",[t._v("其他项目想用的话，手动替换。")]),t._v(" "),s("h3",{attrs:{id:"_3-7-scoped"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_3-7-scoped"}},[t._v("#")]),t._v(" 3.7. scoped")]),t._v(" "),s("p",[t._v("突然意识到小程序根本不需要 "),s("code",[t._v("scoped")]),t._v("，默认情况下，小程序组件样式就是只能作用于自己。于是写了个 "),s("code",[t._v("loader")]),t._v("，在小程序下去掉了所有 "),s("code",[t._v("scoped")]),t._v("，减少了 47KB。")]),t._v(" "),s("img",{attrs:{src:"https://mike-1255355338.cos.ap-guangzhou.myqcloud.com/article/2024/8/own_mike_28e1864b844799c811.png",width:"500"}}),t._v(" "),s("img",{attrs:{src:"https://mike-1255355338.cos.ap-guangzhou.myqcloud.com/article/2024/8/own_mike_bfad98a1eb69e896e3.png",width:"500"}}),t._v(" "),s("p",[t._v("其他项目想用的话，使用 "),s("code",[t._v("plugin-light")]),t._v(" 中的 "),s("code",[t._v("removeScopedLoader")]),t._v("。")]),t._v(" "),s("h3",{attrs:{id:"_3-8-最新进度"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_3-8-最新进度"}},[t._v("#")]),t._v(" 3.8. 最新进度")]),t._v(" "),s("p",[t._v("当前总包 1.512 MB")]),t._v(" "),s("img",{attrs:{src:"https://mike-1255355338.cos.ap-guangzhou.myqcloud.com/article/2024/8/own_mike_d34295e3ea4044dedc.png",width:"500"}}),t._v(" "),s("h2",{attrs:{id:"_4-vue3"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_4-vue3"}},[t._v("#")]),t._v(" 4. Vue3")]),t._v(" "),s("h3",{attrs:{id:"_4-1-包体积"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_4-1-包体积"}},[t._v("#")]),t._v(" 4.1. 包体积")]),t._v(" "),s("p",[t._v("尝试用 Vue3 改写了项目，包体积能降到 900KB。")]),t._v(" "),s("p",[t._v("看了下，之所以能降这么多，除了 "),s("code",[t._v("uni-app")]),t._v(" 运行时变小外，"),s("code",[t._v("js")]),t._v(" 文件的运行时也缩减了很多。"),s("code",[t._v("Vue2.x")]),t._v(" 用的 "),s("code",[t._v("webpack")]),t._v(" 运行时那一套，熟悉的关键词是 "),s("code",[t._v("webpackJsonP")]),t._v("，而 "),s("code",[t._v("Vue3.x")]),t._v(" 用的是 "),s("code",[t._v("Vite")]),t._v("，到了小程序这，转化成了小程序原生的 "),s("code",[t._v("require")]),t._v("。就这一点，就能降不少，因为 JS 模块太多了。")]),t._v(" "),s("p",[t._v("下面记录下 Vue3 升级中的一些问题和解决办法。")]),t._v(" "),s("h3",{attrs:{id:"_4-2-vue2-中的-set"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_4-2-vue2-中的-set"}},[t._v("#")]),t._v(" 4.2. Vue2 中的 $set")]),t._v(" "),s("p",[s("code",[t._v("Vue.set")]),t._v(" 和 "),s("code",[t._v("this.$set")]),t._v(" 区别")]),t._v(" "),s("p",[t._v("说明：两者都是实现向实例对象中添加响应式属性，触发视图更新，两者原理和用法基本相同，都是使用 set,一个绑定在 vue 的构造函数身上，一个绑定在vue的原型身上。")]),t._v(" "),s("ol",[s("li",[s("code",[t._v("vue.set()")]),t._v("，将 set 函数绑定在 Vue 构造函数中，设置实例创建之后添加的新的响应式属性，且触发视图更新，但是不允许添加根级响应式属性，只可以向嵌套对象添加响应式属性。")])]),t._v(" "),s("p",[t._v("用法： "),s("code",[t._v("Vue.set(object, propertyName, value)")])]),t._v(" "),s("div",{staticClass:"language-ts extra-class"},[s("pre",{pre:!0,attrs:{class:"language-ts"}},[s("code",[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("import")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v(" set "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("from")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'../observer/index'")]),t._v("\nVue"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("set "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("set")]),t._v("\n")])])]),s("ol",{attrs:{start:"2"}},[s("li",[s("code",[t._v("this.$set()")]),t._v("**将 set 函数绑定在 vue 原型上，**只能设置实例创建后存在的数据（数据已经在 data 中）")])]),t._v(" "),s("p",[t._v("用法： "),s("code",[t._v("this.$set(object, propertyName, value)")])]),t._v(" "),s("p",[t._v("第一个参数是要添加的对象，第二个是需要添加的属性名key（需要要用引号包裹起来),第三个是需要添加的值)")]),t._v(" "),s("div",{staticClass:"language-ts extra-class"},[s("pre",{pre:!0,attrs:{class:"language-ts"}},[s("code",[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("import")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v(" set "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("from")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'../observer/index'")]),t._v("\nVue"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("prototype"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("$set "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("set")]),t._v("\n")])])]),s("h3",{attrs:{id:"_4-3-maximum-recursive-updates-exceeded"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_4-3-maximum-recursive-updates-exceeded"}},[t._v("#")]),t._v(" 4.3. Maximum recursive updates exceeded")]),t._v(" "),s("p",[t._v("出现了死循环，报错如下：")]),t._v(" "),s("img",{attrs:{src:"https://mike-1255355338.cos.ap-guangzhou.myqcloud.com/article/2024/8/own_mike_abb7c22e5de1650fee.png",width:"500"}}),t._v(" "),s("div",{staticClass:"language- extra-class"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[t._v("Maximum recursive updates exceeded. This means you have a reactive effect \nthat is mutating its own dependencies vendor.j5: 3. and thus recursively \ntriggering itself. Possible sources include component template, render \nfunction, updated hook or watcher source\n")])])]),s("p",[t._v("最后发现是 "),s("code",[t._v("watch")]),t._v(" 使用的不合理，原先代码抽象如下（选项式API）：")]),t._v(" "),s("div",{staticClass:"language-ts extra-class"},[s("pre",{pre:!0,attrs:{class:"language-ts"}},[s("code",[t._v("props"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  task"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    type"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" Object"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("data")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    mTaskInfo"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\nwatch"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("task")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("value"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("this")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("mTaskInfo "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" value"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),s("p",[t._v("上面代码在 "),s("code",[t._v("Vue2.x")]),t._v(" 时候也是不对的，完全可以用 "),s("code",[t._v("computed")]),t._v("。只不是 "),s("code",[t._v("Vue2.x")]),t._v(" 的时候传递的是对象，并不是代理，所以不会出现死循环。")]),t._v(" "),s("p",[t._v("而 "),s("code",[t._v("Vue3.x")]),t._v(" 中传入的这个 "),s("code",[t._v("task")]),t._v(" 是代理对象，执行 "),s("code",[t._v("this.mTaskInfo = value")]),t._v(" 的时候，等于把 "),s("code",[t._v("mTaskInfo")]),t._v(" 和 "),s("code",[t._v("task")]),t._v(" 划上了等号，一旦对 "),s("code",[t._v("mTaskInfo")]),t._v(" 的属性赋值，都会导致 "),s("code",[t._v("task")]),t._v(" 也跟着变，从而死循环。")]),t._v(" "),s("p",[t._v("测试了一下，选项式API中 "),s("code",[t._v("data")]),t._v(" 的属性，如果是基础类型可以获取到原始类型，如果是对象和数组则是代理。"),s("code",[t._v("computed")]),t._v(" 中返回的则始终是原始值。")]),t._v(" "),s("h3",{attrs:{id:"_4-4-h5标签转化"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_4-4-h5标签转化"}},[t._v("#")]),t._v(" 4.4. H5标签转化")]),t._v(" "),s("p",[t._v("vue3 不会在 "),s("code",[t._v("img/div/span")]),t._v(" 这些 H5 标签转化的产物中加额外类名了，比如 "),s("code",[t._v("_img/_div/_span")]),t._v("，之前是")]),t._v(" "),s("img",{attrs:{src:"https://mike-1255355338.cos.ap-guangzhou.myqcloud.com/article/2024/8/own_mike_7223075d1382090f18.png",width:"360"}}),t._v(" "),s("p",[t._v("现在是")]),t._v(" "),s("img",{attrs:{src:"https://mike-1255355338.cos.ap-guangzhou.myqcloud.com/article/2024/8/own_mike_a07d3a1975fd25f5ae.png",width:"360"}}),t._v(" "),s("p",[t._v("需要自己改成")]),t._v(" "),s("div",{staticClass:"language-scss extra-class"},[s("pre",{pre:!0,attrs:{class:"language-scss"}},[s("code",[s("span",{pre:!0,attrs:{class:"token selector"}},[t._v("img, \nimage ")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),s("p",[t._v("更正规的做法是不要使用标签选择器，统一使用类名选择器。")]),t._v(" "),s("p",[t._v("还有一种批量处理方法，就是找到对应关系，用 "),s("code",[t._v("postcss")]),t._v(" 插件批量转化。")]),t._v(" "),s("div",{staticClass:"language- extra-class"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[t._v("span => label\nimg => image\ni => view\np => view\n")])])]),s("p",[t._v("用插件的优点就是很快，缺点是：")]),t._v(" "),s("ol",[s("li",[t._v("不精确，多个web标签都对应 view，可能会导致与 Web 端表现不一致")]),t._v(" "),s("li",[t._v("有心智负担，无法做到可见即所得，不利于后期维护")])]),t._v(" "),s("h2",{attrs:{id:"_5-vue3-转化-tips"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_5-vue3-转化-tips"}},[t._v("#")]),t._v(" 5. Vue3 转化 Tips")]),t._v(" "),s("p",[t._v("为方便其他子工程迁移，贴下转化的基础步骤。")]),t._v(" "),s("h3",{attrs:{id:"_5-1-框架级别"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_5-1-框架级别"}},[t._v("#")]),t._v(" 5.1. 框架级别")]),t._v(" "),s("ol",[s("li",[t._v("复制 "),s("code",[t._v("main.ts")])]),t._v(" "),s("li",[t._v("删掉 "),s("code",[t._v("index.html")]),t._v(" 中的 "),s("code",[t._v("VUE_APP_INDEX_CSS_HASH")])]),t._v(" "),s("li",[t._v("在 "),s("code",[t._v("index.html")]),t._v(" 增加 "),s("code",[t._v("main.ts")]),t._v(" 中的引入")])]),t._v(" "),s("div",{staticClass:"language-html extra-class"},[s("pre",{pre:!0,attrs:{class:"language-html"}},[s("code",[s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),t._v("script")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token attr-name"}},[t._v("type")]),s("span",{pre:!0,attrs:{class:"token attr-value"}},[s("span",{pre:!0,attrs:{class:"token punctuation attr-equals"}},[t._v("=")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v('"')]),t._v("module"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v('"')])]),t._v(" "),s("span",{pre:!0,attrs:{class:"token attr-name"}},[t._v("src")]),s("span",{pre:!0,attrs:{class:"token attr-value"}},[s("span",{pre:!0,attrs:{class:"token punctuation attr-equals"}},[t._v("=")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v('"')]),t._v("/main.ts"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v('"')])]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),s("span",{pre:!0,attrs:{class:"token script"}}),s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("</")]),t._v("script")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("\n")])])]),s("ol",{attrs:{start:"4"}},[s("li",[s("p",[s("code",[t._v("manifest.json")]),t._v(" 中 "),s("code",[t._v("vueVersion")]),t._v(" 改成 3")])]),t._v(" "),s("li",[s("p",[s("code",[t._v("pmd-merchant-ui")]),t._v(" 替换，"),s("code",[t._v("pmd-merchant-ui/src/tip-comp-dialog-prompt/css")]),t._v(" => "),s("code",[t._v("@tencent/press-plus/press-act-prompt-dialog/css")])])])]),t._v(" "),s("h3",{attrs:{id:"_5-2-业务级别"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_5-2-业务级别"}},[t._v("#")]),t._v(" 5.2. 业务级别")]),t._v(" "),s("ol",[s("li",[s("code",[t._v("app.$set")]),t._v(" 和 "),s("code",[t._v("this.$set")]),t._v(" 用 "),s("code",[t._v("press-ui")]),t._v(" 中的 "),s("code",[t._v("setAdapter")]),t._v(" 替换。")])]),t._v(" "),s("div",{staticClass:"language-ts extra-class"},[s("pre",{pre:!0,attrs:{class:"language-ts"}},[s("code",[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("import")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v(" setAdapter "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("from")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'@tencent/press-ui/common/vue3/set'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])])]),s("ol",{attrs:{start:"2"}},[s("li",[s("p",[s("code",[t._v("router.push")]),t._v("， "),s("code",[t._v("router.replace")]),t._v(" 在小程序下，用原生方法实现。")])]),t._v(" "),s("li",[s("p",[t._v("样式文件中的 "),s("code",[t._v("*")]),t._v(" 选择器去掉，小程序不支持")])]),t._v(" "),s("li",[s("p",[t._v("生命周期替换")])]),t._v(" "),s("li",[s("p",[t._v("引入类型，需要加 "),s("code",[t._v("type")])])])]),t._v(" "),s("div",{staticClass:"language-ts extra-class"},[s("pre",{pre:!0,attrs:{class:"language-ts"}},[s("code",[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("import")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("type")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v(" XXType "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("from")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'xx'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])])]),s("ol",{attrs:{start:"6"}},[s("li",[t._v("Vant 组件改成 Press UI 组件，常见的包括 List/Tab/Swiper 等。")])]),t._v(" "),s("h2",{attrs:{id:"_6-赛事转化"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_6-赛事转化"}},[t._v("#")]),t._v(" 6. 赛事转化")]),t._v(" "),s("p",[t._v("转化步骤：")]),t._v(" "),s("ol",[s("li",[t._v("拷贝文件")]),t._v(" "),s("li",[t._v("运行 "),s("code",[t._v("npm run dev")]),t._v(", 改一些问题")]),t._v(" "),s("li",[t._v("运行 "),s("code",[t._v("npm run build")]),t._v(" 改编译问题")]),t._v(" "),s("li",[t._v("再运行 "),s("code",[t._v("npm run dev")]),t._v(" 改运行时问题")])]),t._v(" "),s("p",[t._v("先执行 "),s("code",[t._v("npm run dev")]),t._v(" 是因为 "),s("code",[t._v("Vite")]),t._v(" 按需加载，能较快看到成果，心里有底。")]),t._v(" "),s("p",[t._v("再执行 "),s("code",[t._v("npm run build")]),t._v(" 是因为 "),s("code",[t._v("build")]),t._v(" 模式能看到所有编译问题，方便快速定位和解决。")]),t._v(" "),s("p",[t._v("最后运行 "),s("code",[t._v("npm run dev")]),t._v(" 就是查漏补缺，把每个页面的运行时都检查一遍。")]),t._v(" "),s("p",[t._v("编译问题：")]),t._v(" "),s("ol",[s("li",[t._v("路径移动，需与之前项目融合，所以要改动引入路径部分")]),t._v(" "),s("li",[t._v("业务大量使用了 Vuex，去掉有风险，也引入 "),s("code",[t._v("4.x")]),t._v(" 版本的 Vuex")]),t._v(" "),s("li",[s("code",[t._v("template")]),t._v(" 内的 key 需要写在 "),s("code",[t._v("template")]),t._v(" 标签上")]),t._v(" "),s("li",[s("code",[t._v("vue-qrcode")]),t._v(" 库替换成 press-ui 中的 "),s("code",[t._v("qrcode")])]),t._v(" "),s("li",[s("code",[t._v("vant/lib")]),t._v(" 库的动态引入，用条件编译包裹")]),t._v(" "),s("li",[s("code",[t._v("@ttt/pmd-api")]),t._v(" 替换成 "),s("code",[t._v("src/api")])]),t._v(" "),s("li",[t._v("增加必须的 "),s("code",[t._v("mixin")]),t._v("，比如 "),s("code",[t._v("share-mixin")])])]),t._v(" "),s("p",[t._v("运行时问题：")]),t._v(" "),s("ol",[s("li",[t._v("业务大量使用了 "),s("code",[t._v("$router")]),t._v("，需要改成 "),s("code",[t._v("uni.navigateTo")]),t._v(" 等")]),t._v(" "),s("li",[t._v("空的 "),s("code",[t._v("template")]),t._v(" 标签会产生 "),s("code",[t._v("fragment")]),t._v("，导致白屏")]),t._v(" "),s("li",[t._v("对 "),s("code",[t._v("img/span/i")]),t._v(" 等标签进行转换，可以用插件，用插件的优劣见上面。")]),t._v(" "),s("li",[t._v("在页面中，对 "),s("code",[t._v("global-component")]),t._v(" 等组件进行手动注入")])]),t._v(" "),s("h2",{attrs:{id:"_7-冰山之下"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_7-冰山之下"}},[t._v("#")]),t._v(" 7. 冰山之下")]),t._v(" "),s("p",[t._v("上层业务改动其实只是冰山之上，做了一些对普通开发者无感知的工程相关工作，是冰山之下，这里介绍下。")]),t._v(" "),s("ol",[s("li",[t._v("脚手架")]),t._v(" "),s("li",[t._v("通用Vite配置")]),t._v(" "),s("li",[t._v("H5发布")]),t._v(" "),s("li",[t._v("小程序CI")]),t._v(" "),s("li",[t._v("合包流失线")]),t._v(" "),s("li",[t._v("统一的代码规范")]),t._v(" "),s("li",[t._v("组件库和工具库的兼容")])]),t._v(" "),s("h3",{attrs:{id:"_7-1-通用-vite-配置"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_7-1-通用-vite-配置"}},[t._v("#")]),t._v(" 7.1. 通用 Vite 配置")]),t._v(" "),s("p",[t._v("通用 Vite 配置兼容项目底层库，让业务无缝升级 Vue3，具体包括以下内容。")]),t._v(" "),s("h4",{attrs:{id:"_7-1-1-插件支持"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_7-1-1-插件支持"}},[t._v("#")]),t._v(" 7.1.1. 插件支持")]),t._v(" "),s("ol",[s("li",[t._v("支持条件编译")]),t._v(" "),s("li",[t._v("支持关键词跨平台文件编译")]),t._v(" "),s("li",[t._v("支持关键词跨平台样式编译")]),t._v(" "),s("li",[t._v("支持 "),s("code",[t._v("rem")]),t._v(" 转 "),s("code",[t._v("rpx")])]),t._v(" "),s("li",[t._v("支持小程序下转化 "),s("code",[t._v("v-lazy")]),t._v(" 指令")]),t._v(" "),s("li",[t._v("支持小程序下去掉 Vue 指令")]),t._v(" "),s("li",[t._v("支持构建产物分析")]),t._v(" "),s("li",[t._v("支持 QQ 小程序下中 "),s("code",[t._v("globalThis polyFill")])]),t._v(" "),s("li",[t._v("支持输出版本信息")]),t._v(" "),s("li",[t._v("支持输出不兼容语法的警告信息")]),t._v(" "),s("li",[t._v("支持动态修改 "),s("code",[t._v("vue.runtime.js")]),t._v("，解决编译问题")])]),t._v(" "),s("img",{attrs:{src:"https://mike-1255355338.cos.ap-guangzhou.myqcloud.com/article/2024/9/own_mike_ba280fde6f7614a7a2.png",width:"500"}}),t._v(" "),s("h4",{attrs:{id:"_7-1-2-插件修复-uni-app-内部问题"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_7-1-2-插件修复-uni-app-内部问题"}},[t._v("#")]),t._v(" 7.1.2. 插件修复 uni-app 内部问题")]),t._v(" "),s("ol",[s("li",[t._v("修复 uni-app 中自带 "),s("code",[t._v("useRem")]),t._v(" 函数带来的样式适配问题")])]),t._v(" "),s("p",[t._v("uni-app Vue2 版本的 H5 会把 "),s("code",[t._v("rpx")]),t._v(" 转成 "),s("code",[t._v("px")]),t._v("，在 Vue3 版本中，会把 "),s("code",[t._v("rpx")]),t._v(" 转成 "),s("code",[t._v("rem")]),t._v("，且算法与我们业务不一样，并且即使你没用 "),s("code",[t._v("rpx")]),t._v("，他也会在 "),s("code",[t._v("html")]),t._v(" 挂上他计算出来的 "),s("code",[t._v("font-size")]),t._v("，这个必须去掉。查看源码，其实就是这个 "),s("code",[t._v("useRem")]),t._v(" 函数，这里写了插件用 "),s("code",[t._v("AST")]),t._v(" 去掉。")]),t._v(" "),s("p",[t._v("至于 Vue2 版本中是如何将 "),s("code",[t._v("rpx")]),t._v(" 转成 "),s("code",[t._v("px")]),t._v(" 的，可以看 "),s("code",[t._v("node_modules/@dcloudio/vue-cli-plugin-uni/packages/postcss/index.js")]),t._v(" 文件，其是一个 "),s("code",[t._v("postcss")]),t._v(" 插件，会把 "),s("code",[t._v("rpx")]),t._v(" 先转成 "),s("code",[t._v("%?${num}?%")]),t._v(" 这种格式，然后在 "),s("code",[t._v("styleLoader")]),t._v(" 中将符合该正则的字符串通过 "),s("code",[t._v("upx2px")]),t._v(" 转成 "),s("code",[t._v("px")]),t._v("。")]),t._v(" "),s("ol",{attrs:{start:"2"}},[s("li",[t._v("修复 uni-app 中 "),s("code",[t._v("monorepo")]),t._v(" 仓库下打包路径问题")])]),t._v(" "),s("p",[t._v("uni-app 运行时生成的引用路径错误，查看源码发现是 "),s("code",[t._v("packages/uni-cli-shared/src/utils.ts")]),t._v(" 中的问题:")]),t._v(" "),s("div",{staticClass:"language-ts extra-class"},[s("pre",{pre:!0,attrs:{class:"language-ts"}},[s("code",[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("export")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("function")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("normalizeMiniProgramFilename")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("\n  filename"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("string")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  inputDir"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("?")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("string")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("!")]),t._v("inputDir "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("||")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("!")]),t._v("path"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("isAbsolute")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("filename"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("normalizeNodeModules")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("filename"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("normalizeNodeModules")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("path"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("relative")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("inputDir"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" filename"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),s("p",[t._v("这里举个例子，"),s("code",[t._v("filename")]),t._v(" 为 "),s("code",[t._v("/Users/yang/Documents/git-woa/guandan-match/node_modules/@tencent/press-ui/press-info/press-info.vue")]),t._v("，"),s("code",[t._v("inputDir")]),t._v(" 为 "),s("code",[t._v("./src/project/guandan-match")]),t._v(" 时，"),s("code",[t._v("path.relative")]),t._v(" 生成的路径就会带上 "),s("code",[t._v("../")]),t._v("，这里背后的逻辑是 "),s("code",[t._v("inputDir")]),t._v(" 和 "),s("code",[t._v("node_modules")]),t._v(" 必须是同一级。")]),t._v(" "),s("p",[t._v("uni-app 社区也有其他人遇到了相同问题，参见：")]),t._v(" "),s("ul",[s("li",[t._v("https://ask.dcloud.net.cn/question/152306")]),t._v(" "),s("li",[t._v("https://github.com/dcloudio/uni-app/issues/3049")])]),t._v(" "),s("p",[t._v("如何解决呢？")]),t._v(" "),s("p",[t._v("尝试了覆盖 "),s("code",[t._v("rollupOptions")]),t._v("，发现不够，采用的是脚本改源码 + 插件修改 "),s("code",[t._v("rollupOptions.output.chunkFileNames")]),t._v("。")]),t._v(" "),s("ol",[s("li",[t._v("修复 uni-app QQ小程序打包后 "),s("code",[t._v("appId")]),t._v(" 错误问题")])]),t._v(" "),s("p",[t._v("这个解决办法就是用插件将 "),s("code",[t._v("manifest.json")]),t._v(" 中正确的 "),s("code",[t._v("appId")]),t._v(" 复制到产物中。")]),t._v(" "),s("ol",{attrs:{start:"4"}},[s("li",[t._v("修复 uni-app 小程序下样式文件变化无法重新编译的问题")])]),t._v(" "),s("p",[t._v("小程序开发时，独立的 "),s("code",[t._v("sass")]),t._v(" 文件改动后并不会重新编译，用一个全新的示例工程也不可以。看了下源码，uni-app 是用 "),s("code",[t._v("import('vite').then({build}=>{})")]),t._v(" 这种方式来启动的。")]),t._v(" "),s("p",[t._v("解决办法是利用 "),s("code",[t._v("gulp.watch")]),t._v("，监听 "),s("code",[t._v("./src/**/*.scss")]),t._v(" 文件，然后修改下 "),s("code",[t._v("main.ts")]),t._v("，然后这样就能重新编译了。同时加上了 "),s("code",[t._v("debounce")]),t._v("。")]),t._v(" "),s("h4",{attrs:{id:"_7-1-3-配置支持"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_7-1-3-配置支持"}},[t._v("#")]),t._v(" 7.1.3. 配置支持")]),t._v(" "),s("ol",[s("li",[t._v("支持根据环境变量修改 "),s("code",[t._v("manifest")]),t._v(" 中 "),s("code",[t._v("h5.router.base")]),t._v("，实现业务上云")]),t._v(" "),s("li",[t._v("支持小程序下劫持 "),s("code",[t._v("window")]),t._v(", "),s("code",[t._v("location")]),t._v(", "),s("code",[t._v("localStorage")]),t._v(" 等变量")]),t._v(" "),s("li",[t._v("支持 "),s("code",[t._v("src")]),t._v(" 等开头的 "),s("code",[t._v("alias")])]),t._v(" "),s("li",[t._v("支持 H5 下三方库设置外链")])]),t._v(" "),s("p",[t._v("对 "),s("code",[t._v("window/location/localStorage")]),t._v(" 等变量的劫持并不能用之前的方式，之前是通过 "),s("code",[t._v("new Vue")]),t._v("，然后将那些变量的属性当作 "),s("code",[t._v("Vue")]),t._v(" 的 "),s("code",[t._v("data、computed、method")]),t._v(" 等。在 Vue3 中，则需要改成 "),s("code",[t._v("reactive")]),t._v(" 实现响应式。")]),t._v(" "),s("p",[t._v("举个例子，对于 "),s("code",[t._v("cookie")]),t._v("，Vue2 的劫持是：")]),t._v(" "),s("div",{staticClass:"language-js extra-class"},[s("pre",{pre:!0,attrs:{class:"language-js"}},[s("code",[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" $document "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("new")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Vue")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("data")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n      "),s("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("location")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" $location"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n      "),s("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("body")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" $body"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("computed")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("cookie")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n      "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("set")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("newVal"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        $localStorage"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("setItem")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'uni-app-cookie'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" newVal"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n      "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n      "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("get")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" $localStorage"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("getItem")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'uni-app-cookie'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("||")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("''")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n      "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("methods")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("querySelector")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("globalThis "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("as")]),t._v(" unknown "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("as")]),t._v(" GlobalThis"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("$document "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" $document"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])])]),s("p",[t._v("Vue3 下是")]),t._v(" "),s("div",{staticClass:"language-ts extra-class"},[s("pre",{pre:!0,attrs:{class:"language-ts"}},[s("code",[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" $document "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("reactive")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  location"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" $location"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  body"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" $body"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n\n  cookie"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("computed")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("set")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("newVal"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n      $localStorage"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("setItem")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'uni-app-cookie'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" newVal"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("get")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n      "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" $localStorage"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("getItem")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'uni-app-cookie'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("||")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("''")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("querySelector")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])])]),s("div",{staticClass:"language-ts extra-class"},[s("pre",{pre:!0,attrs:{class:"language-ts"}},[s("code",[s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// vite.config.ts")]),t._v("\n\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  define"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    document"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'globalThis.$document'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),s("h3",{attrs:{id:"_7-2-脚手架"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_7-2-脚手架"}},[t._v("#")]),t._v(" 7.2. 脚手架")]),t._v(" "),s("p",[t._v("实现 "),s("strong",[t._v("uni-app + Vue3 项目、普通 Vue3 项目")]),t._v("的脚手架及模版搭建，可以一键创建新的工程、子工程，并接入了研发平台。")]),t._v(" "),s("p",[t._v("开发者一键创建后，只需安装依赖、配置环境变量两步，就可以进入业务开发，体验与 Vue2 工程一致，无需进行工程配置、Eslint配置等，无额外心智负担。")]),t._v(" "),s("h3",{attrs:{id:"_7-3-ci"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_7-3-ci"}},[t._v("#")]),t._v(" 7.3. CI")]),t._v(" "),s("p",[t._v("对 "),s("strong",[t._v("H5发布、小程序CI、合包流水线")]),t._v("做了改造，均支持 Vue3 项目，普通开发者无感知。")]),t._v(" "),s("ul",[s("li",[t._v("H5发布同样支持 "),s("code",[t._v("history")]),t._v(" 模式 和 "),s("code",[t._v("hash")]),t._v(" 模式，编译速度更快")]),t._v(" "),s("li",[t._v("小程序CI同样支持微信和QQ双端，支持包大小记录、消息通知、错误提醒等")]),t._v(" "),s("li",[t._v("合包流水线支持其他子工程扩展，有一定通用性")])]),t._v(" "),s("h3",{attrs:{id:"_7-4-代码规范"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_7-4-代码规范"}},[t._v("#")]),t._v(" 7.4. 代码规范")]),t._v(" "),s("p",[t._v("样式规范无需变化，至于 "),s("code",[t._v("Eslint")]),t._v(" 规范，发布了 "),s("code",[t._v("eslint-config-light-vue3")]),t._v("，更适合 "),s("code",[t._v("Vue3")]),t._v(" 项目，并已对齐公司规范。")]),t._v(" "),s("h3",{attrs:{id:"_7-5-组件库和工具库"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_7-5-组件库和工具库"}},[t._v("#")]),t._v(" 7.5. 组件库和工具库")]),t._v(" "),s("p",[t._v("组件库和工具库同时支持 Vue2 和 Vue3，这一点尤为重要，只有底层组件和工具都支持了，上层业务升级时才有底气。")]),t._v(" "),s("p",[t._v("Press UI 组件库支持 "),s("code",[t._v("2*(n+1)")]),t._v(" 端，"),s("code",[t._v("2")]),t._v(" 指的是 Vue2 + Vue3，"),s("code",[t._v("n")]),t._v(" 指的是 uni-app 支持的 H5、各种小程序、APP等，"),s("code",[t._v("1")]),t._v(" 指的是非 uni-app 的 H5。")]),t._v(" "),s("p",[t._v("工欲善其事，必先利其器。Press UI 组件库其实就是“利好的器”。")])])}),[],!1,null,null,null);s.default=e.exports}}]);