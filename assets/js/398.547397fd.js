(window.webpackJsonp=window.webpackJsonp||[]).push([[398],{673:function(t,s,a){"use strict";a.r(s);var n=a(14),p=Object(n.a)({},(function(){var t=this,s=t._self._c;return s("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[s("h2",{attrs:{id:"_1-方案"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_1-方案"}},[t._v("#")]),t._v(" 1. 方案")]),t._v(" "),s("p",[t._v("这里主要是对组件分发插件的优化，之前插件是在"),s("code",[t._v("compiler.hooks.done")]),t._v("这个钩子上进行操作的，包括读取文件、修改引用、写入文件。")]),t._v(" "),s("p",[t._v("其实可以在其他钩子中操作asset，也就是在输出文件之前就处理好，总结起来就一句话，在内存中操作总比IO快。")]),t._v(" "),s("p",[t._v("实际编码中，是在"),s("code",[t._v("compiler.hooks.emit")]),t._v("钩子中操作，通过"),s("code",[t._v("compilation.assets")]),t._v("，拿到待输出的资源。")]),t._v(" "),s("p",[s("code",[t._v("assets")]),t._v("是资源的对象，key 是文件相对路径，value 是个对象，有 source/info/size 等属性，其中，source是函数，返回的就是文件内容。")]),t._v(" "),s("p",[t._v("通过增删改 assets 就可以操作输出资源了。")]),t._v(" "),s("div",{staticClass:"language-ts extra-class"},[s("pre",{pre:!0,attrs:{class:"language-ts"}},[s("code",[s("span",{pre:!0,attrs:{class:"token function"}},[t._v("apply")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("compiler"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  compiler"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("hooks"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("emit"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("tap")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'moveComponentPlugin'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("compilation"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=>")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v(" assets "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" compilation"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n      parsedReplaceRefList"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n      movingComponents"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("analyzeComponent")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("this")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("options"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("this")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("copyComponents")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("assets"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" movingComponents"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("this")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("modifyRef")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("assets"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" parsedReplaceRefList"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("this")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("deleteComponents")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("assets"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" movingComponents"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),s("p",[t._v("类似的，还有其他插件直接操作文件的，都可以改成这种方式。")]),t._v(" "),s("h2",{attrs:{id:"_2-效果"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_2-效果"}},[t._v("#")]),t._v(" 2. 效果")]),t._v(" "),s("p",[t._v("如何对比改进前后的打包时间呢？可以写个插件，但更简单的是在执行命令前打印一下时间戳，在执行命令后再打印下时间戳就可以了。")]),t._v(" "),s("p",[t._v("改进前：")]),t._v(" "),s("ul",[s("li",[s("p",[t._v("插件执行时间：1661170044696 - 1661169849984 = 194712，约"),s("strong",[t._v("195s")])])]),t._v(" "),s("li",[s("p",[t._v("打包总时间：1661170047149 - 1661169773593 = 273556，约"),s("strong",[t._v("274s")])])])]),t._v(" "),s("p",[t._v("改进后：")]),t._v(" "),s("ul",[s("li",[s("p",[t._v("插件执行时间：1661169591728 - 1661169589082 = 2646，约"),s("strong",[t._v("3s")])])]),t._v(" "),s("li",[s("p",[t._v("打包总时间：1661169594229 - 1661169521873 = 72356，约"),s("strong",[t._v("72s")])])])]),t._v(" "),s("p",[t._v("对比下，"),s("strong",[t._v("改进后的插件执行时间减少了192s，打包总时间减少了202s，总体上效率提升了3倍")]),t._v("。")]),t._v(" "),s("p",[t._v("另外说下，这个改进的其他两个好处：")]),t._v(" "),s("ol",[s("li",[t._v("可以在本地开发时也使用此插件，不再会因为修改了一行代码而等几分钟")]),t._v(" "),s("li",[t._v("也可以"),s("code",[t._v("build:mp")]),t._v("和"),s("code",[t._v("dev:mp")]),t._v("两个命令同时运行，不会因为都操作同一处的公共文件而产生异常")])]),t._v(" "),s("h2",{attrs:{id:"_3-总结"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_3-总结"}},[t._v("#")]),t._v(" 3. 总结")]),t._v(" "),s("ol",[s("li",[t._v("选对操作的钩子，这个例子中是从原来的"),s("code",[t._v("compiler.hooks.done")]),t._v("钩子变成"),s("code",[t._v("compiler.hooks.emit")]),t._v("钩子。")]),t._v(" "),s("li",[t._v("尽量不要操作编译后产物，这个例子操作的是assets，主要是基本的增删改。")]),t._v(" "),s("li",[t._v("尽量避免O(N^2)的算法，可以提前处理好数据，降低时间复杂度。")])])])}),[],!1,null,null,null);s.default=p.exports}}]);