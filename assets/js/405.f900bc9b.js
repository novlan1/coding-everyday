(window.webpackJsonp=window.webpackJsonp||[]).push([[405],{676:function(a,s,t){"use strict";t.r(s);var _=t(14),v=Object(_.a)({},(function(){var a=this,s=a._self._c;return s("ContentSlotsDistributor",{attrs:{"slot-key":a.$parent.slotKey}},[s("p"),s("div",{staticClass:"table-of-contents"},[s("ul",[s("li",[s("a",{attrs:{href:"#_1-开始"}},[a._v("1. 开始")])]),s("li",[s("a",{attrs:{href:"#_2-优化点"}},[a._v("2. 优化点")]),s("ul",[s("li",[s("a",{attrs:{href:"#_2-1-多环境区分"}},[a._v("2.1. 多环境区分")])]),s("li",[s("a",{attrs:{href:"#_2-2-配置驱动"}},[a._v("2.2. 配置驱动")])]),s("li",[s("a",{attrs:{href:"#_2-3-自动重试"}},[a._v("2.3. 自动重试")])]),s("li",[s("a",{attrs:{href:"#_2-4-并行提速"}},[a._v("2.4. 并行提速")])]),s("li",[s("a",{attrs:{href:"#_2-5-canvas绘图"}},[a._v("2.5. canvas绘图")])]),s("li",[s("a",{attrs:{href:"#_2-6-定时执行"}},[a._v("2.6. 定时执行")])])])]),s("li",[s("a",{attrs:{href:"#_3-其他"}},[a._v("3. 其他")]),s("ul",[s("li",[s("a",{attrs:{href:"#_3-1-canvas"}},[a._v("3.1. canvas")])]),s("li",[s("a",{attrs:{href:"#_3-2-变量传递问题"}},[a._v("3.2. 变量传递问题")])]),s("li",[s("a",{attrs:{href:"#_3-3-qq小程序体验版"}},[a._v("3.3. qq小程序体验版")])]),s("li",[s("a",{attrs:{href:"#_3-4-扩展性"}},[a._v("3.4. 扩展性")])])])])])]),s("p"),a._v(" "),s("h2",{attrs:{id:"_1-开始"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_1-开始"}},[a._v("#")]),a._v(" 1. 开始")]),a._v(" "),s("p",[a._v("最近做了小程序的持续集成相关的工作，主要解决了以下痛点：")]),a._v(" "),s("ol",[s("li",[a._v("构建时间长，流程繁琐")]),a._v(" "),s("li",[a._v("外部开发人员无法预览")])]),a._v(" "),s("p",[a._v("本次CI功能点如下：")]),a._v(" "),s("ol",[s("li",[a._v("自动进行uni-app打包，打包两份：test和release环境")]),a._v(" "),s("li",[a._v("将打包产物自动上传")]),a._v(" "),s("li",[a._v("自动预览、生成图片")]),a._v(" "),s("li",[a._v("将预览图片上传到腾讯云")]),a._v(" "),s("li",[a._v("发送构建通知、腾讯云图片地址到企业微信")])]),a._v(" "),s("h2",{attrs:{id:"_2-优化点"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_2-优化点"}},[a._v("#")]),a._v(" 2. 优化点")]),a._v(" "),s("p",[a._v("相比普通的CI，本次优化点有以下几个。")]),a._v(" "),s("h3",{attrs:{id:"_2-1-多环境区分"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_2-1-多环境区分"}},[a._v("#")]),a._v(" 2.1. 多环境区分")]),a._v(" "),s("p",[a._v("对于开发版，同一个开发者只能保留一份，当我们既想看测试环境，又想看正式环境时就捉襟见肘了。")]),a._v(" "),s("p",[a._v("借助小程序ci，对多个环境用不同的机器人，这样就不会覆盖了。")]),a._v(" "),s("h3",{attrs:{id:"_2-2-配置驱动"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_2-2-配置驱动"}},[a._v("#")]),a._v(" 2.2. 配置驱动")]),a._v(" "),s("p",[a._v("由于小程序ci机器人范围有限（1-30），所以只能手动维护，让其重复利用。")]),a._v(" "),s("p",[a._v("这里我让项目每个分支每个环境分别对应一个机器人，当一个分支废弃后，这个机器人就可以释放给其他分支使用。")]),a._v(" "),s("p",[a._v("另外，"),s("code",[a._v("develop")]),a._v("、"),s("code",[a._v("release")]),a._v("这两个分支是不会废弃的，其对应的机器人是固定的，可以体现在流水线中，如：")]),a._v(" "),s("ul",[s("li",[a._v("wx_ci__esports_11__release__test")]),a._v(" "),s("li",[a._v("wx_ci__esports_12__release__release")]),a._v(" "),s("li",[a._v("wx_ci__esports_13__develop__test")]),a._v(" "),s("li",[a._v("wx_ci__esports_14__develop__release")])]),a._v(" "),s("p",[a._v("为什么不让最重要的"),s("code",[a._v("release")]),a._v("分支的机器人序号为1呢？因为1是默认机器人的位置，这会导致"),s("code",[a._v("release")]),a._v("版本很容易被覆盖。")]),a._v(" "),s("p",[a._v("同时其他配置项也可以统一保管起来，比如腾讯云密钥、小程序密钥等，方便维护。")]),a._v(" "),s("h3",{attrs:{id:"_2-3-自动重试"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_2-3-自动重试"}},[a._v("#")]),a._v(" 2.3. 自动重试")]),a._v(" "),s("p",[a._v("有时候上传或者预览会失败，可能是环境问题，也可能是多个流水线同时上传会冲突，因为需要增加自动重试功能。")]),a._v(" "),s("h3",{attrs:{id:"_2-4-并行提速"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_2-4-并行提速"}},[a._v("#")]),a._v(" 2.4. 并行提速")]),a._v(" "),s("p",[a._v("上传和预览是可以同步进行的，这样可以节省一些构建时间。")]),a._v(" "),s("h3",{attrs:{id:"_2-5-canvas绘图"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_2-5-canvas绘图"}},[a._v("#")]),a._v(" 2.5. canvas绘图")]),a._v(" "),s("p",[a._v("小程序ci默认提供的图片只有二维码，笔者用canvas将一些构建信息和二维码绘制到一张新图上，方便定位和查看。")]),a._v(" "),s("p",[a._v("绘制的信息示例：")]),a._v(" "),s("ul",[s("li",[a._v("版本号：1.0.5")]),a._v(" "),s("li",[a._v("提交者：CI机器人5")]),a._v(" "),s("li",[a._v("环境：test")]),a._v(" "),s("li",[a._v("分支：release")]),a._v(" "),s("li",[a._v("构建时间：2022-10-19: 09:36:37")]),a._v(" "),s("li",[a._v("最后提交：lee - 修复page")]),a._v(" "),s("li",[a._v("二维码")])]),a._v(" "),s("h3",{attrs:{id:"_2-6-定时执行"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_2-6-定时执行"}},[a._v("#")]),a._v(" 2.6. 定时执行")]),a._v(" "),s("p",[a._v("由于开发版二维码存在有效期，这里加了个定时执行，这样可以保持二维码最新，不会失效。")]),a._v(" "),s("h2",{attrs:{id:"_3-其他"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_3-其他"}},[a._v("#")]),a._v(" 3. 其他")]),a._v(" "),s("h3",{attrs:{id:"_3-1-canvas"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_3-1-canvas"}},[a._v("#")]),a._v(" 3.1. canvas")]),a._v(" "),s("p",[a._v("canvas版本需要和node版本匹配才可以，否则会报一些奇奇怪怪的错，这里直接在CI中安装对应的canvas版本，并用bash脚本调用js脚本的方式来解决。部分代码如下：")]),a._v(" "),s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[s("span",{pre:!0,attrs:{class:"token builtin class-name"}},[a._v("cd")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token variable"}},[a._v("$WORKSPACE")]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token builtin class-name"}},[a._v("echo")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[a._v('"VUE_APP_AUTHOR = CI ROBOT '),s("span",{pre:!0,attrs:{class:"token variable"}},[a._v("${robot}")]),a._v('"')]),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v(">>")]),a._v(".env.local\n\n"),s("span",{pre:!0,attrs:{class:"token builtin class-name"}},[a._v("echo")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[a._v('"\n// ...\n"')]),a._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v(">")]),a._v(" tmp-mp-ci.js\n\n"),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("npm")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("install")]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("npm")]),a._v(" i miniprogram-ci\n"),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("npm")]),a._v(" i canvas@2.6.1\n"),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("npm")]),a._v(" i t-comm@latest "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("--registry")]),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),a._v("https://registry.npmjs.org/ \n\n\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("if")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("[")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("[")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[a._v('"'),s("span",{pre:!0,attrs:{class:"token variable"}},[a._v("${env}")]),a._v('"')]),a._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[a._v('"production"')]),a._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("]")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("]")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(";")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("then")]),a._v("\n  "),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("npm")]),a._v(" run build:mp:prod\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("else")]),a._v(" \n  "),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("npm")]),a._v(" run build:mp\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("fi")]),a._v("\n\n"),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("node")]),a._v(" tmp-mp-ci.js\n")])])]),s("h3",{attrs:{id:"_3-2-变量传递问题"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_3-2-变量传递问题"}},[a._v("#")]),a._v(" 3.2. 变量传递问题")]),a._v(" "),s("p",[a._v("流水线中nodejs脚本中获取CI变量十分容易，只需要"),s("code",[a._v("${env}")]),a._v("即可。")]),a._v(" "),s("p",[a._v("但是一个普通的打包时才会运行的nodejs脚本，如何获得CI变量呢？")]),a._v(" "),s("p",[a._v("可以把CI变量写到环境变量文件中，比如"),s("code",[a._v(".env.local")]),a._v("，然后打包时读取这个文件。")]),a._v(" "),s("div",{staticClass:"language- extra-class"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[a._v("CI变量 => 写入环境变量文件 => 打包时读取文件\n")])])]),s("h3",{attrs:{id:"_3-3-qq小程序体验版"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_3-3-qq小程序体验版"}},[a._v("#")]),a._v(" 3.3. qq小程序体验版")]),a._v(" "),s("p",[a._v("QQ小程序可以在ci中设置体验版，如何用实例的方式控制呢？")]),a._v(" "),s("p",[a._v("如果单独建一个专门的非实例化的流水线，维护成本会变高，这里可以复制下上个步骤，复制的job只更改一个地方——设置体验版，然后用流水线变量控制。")]),a._v(" "),s("h3",{attrs:{id:"_3-4-扩展性"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_3-4-扩展性"}},[a._v("#")]),a._v(" 3.4. 扩展性")]),a._v(" "),s("p",[a._v("这里讨论下本CI的扩展性，当有新项目接入时，只需要做：")]),a._v(" "),s("ol",[s("li",[a._v("增加一条新的配置")]),a._v(" "),s("li",[a._v("实例化新项目的流水线")])]),a._v(" "),s("p",[a._v("可以看到，非常简单。")]),a._v(" "),s("p",[a._v("当原有项目更新时，或者CI框架变动时，只需要做：")]),a._v(" "),s("ol",[s("li",[a._v("更新配置")]),a._v(" "),s("li",[a._v("CI命令更新")])])])}),[],!1,null,null,null);s.default=v.exports}}]);