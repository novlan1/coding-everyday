(window.webpackJsonp=window.webpackJsonp||[]).push([[29],{330:function(t,a,s){"use strict";s.r(a);var e=s(25),n=Object(e.a)({},(function(){var t=this,a=t._self._c;return a("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[a("ul",[a("li",[a("a",{attrs:{href:"#1-sequelize"}},[t._v("1. Sequelize")]),t._v(" "),a("ul",[a("li",[a("a",{attrs:{href:"#11-%E8%BF%9E%E6%8E%A5%E6%B1%A0"}},[t._v("1.1. 连接池")])]),t._v(" "),a("li",[a("a",{attrs:{href:"#12-%E5%B8%B8%E7%94%A8-api"}},[t._v("1.2. 常用 API")])]),t._v(" "),a("li",[a("a",{attrs:{href:"#13-sequelize-%E5%AE%9E%E7%8E%B0%E4%BA%8B%E5%8A%A1"}},[t._v("1.3. Sequelize 实现事务")])]),t._v(" "),a("li",[a("a",{attrs:{href:"#14-allowedmethods"}},[t._v("1.4. "),a("code",[t._v("allowedMethods")])])]),t._v(" "),a("li",[a("a",{attrs:{href:"#15-%E6%B3%A8%E6%84%8F%E4%BA%8B%E9%A1%B9"}},[t._v("1.5. 注意事项")])]),t._v(" "),a("li",[a("a",{attrs:{href:"#16-%E6%A8%A1%E7%B3%8A%E5%8C%B9%E9%85%8D"}},[t._v("1.6. 模糊匹配")])]),t._v(" "),a("li",[a("a",{attrs:{href:"#17-%E6%8E%92%E9%99%A4%E5%AD%97%E6%AE%B5"}},[t._v("1.7. 排除字段")])])])])]),t._v(" "),a("h3",{attrs:{id:"_1-sequelize"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_1-sequelize"}},[t._v("#")]),t._v(" 1. Sequelize")]),t._v(" "),a("p",[t._v("使用"),a("code",[t._v("wamp")]),t._v("，安装"),a("code",[t._v("mysql")]),t._v("简单，并且可以用"),a("code",[t._v("phpmyadmin")]),t._v("可视化数据库")]),t._v(" "),a("p",[t._v("在koa中用"),a("code",[t._v("sequelize")]),t._v("管理数据库，必须"),a("code",[t._v("npm install mysql2")]),t._v("，以及"),a("code",[t._v("npm install sequelize")])]),t._v(" "),a("p",[a("code",[t._v("sequelize")]),t._v("中事务 "),a("code",[t._v("transaction")]),t._v(" 须和"),a("code",[t._v("where")]),t._v("同级")]),t._v(" "),a("h4",{attrs:{id:"_1-1-连接池"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_1-1-连接池"}},[t._v("#")]),t._v(" 1.1. 连接池")]),t._v(" "),a("ul",[a("li",[t._v("如果池中有空闲连接可用，返回该连接。")]),t._v(" "),a("li",[t._v("如果池中连接都已用完，创建一个新连接添加到池中。")]),t._v(" "),a("li",[t._v("如果池中连接已达到最大连接数，请求进入等待队列直到有空闲连接可用。")])]),t._v(" "),a("p",[t._v("sequelize连接池，默认最小是0，最大是5。")]),t._v(" "),a("ul",[a("li",[a("code",[t._v("idle")]),t._v(" 参数是指闲置的连接超过多少毫秒被释放。")]),t._v(" "),a("li",[a("code",[t._v("acquire")]),t._v(" 参数是指在建立连接出错的时候，在抛出错误之前，池子会尝试建立连接的最大时间，重新连接成功就不抛出错误，不行才再抛。")])]),t._v(" "),a("h4",{attrs:{id:"_1-2-常用-api"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_1-2-常用-api"}},[t._v("#")]),t._v(" 1.2. 常用 API")]),t._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[t._v("// 只选择相应属性\nModel.findAll( {\n  attributes: [ 'foo', 'bar' ]\n} );\n\n// 除开某些属性\nModel.findAll( {\n  attributes: { exclude: [ 'baz' ] }\n} );\n")])])]),a("div",{staticClass:"language-js extra-class"},[a("pre",{pre:!0,attrs:{class:"language-js"}},[a("code",[a("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("freezeTableName")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("true")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 默认false修改表名为复数，true不修改表名，与数据库表名同步")]),t._v("\n")])])]),a("p",[t._v("Mysql分组查询，如求三种类别图书的点赞数目")]),t._v(" "),a("div",{staticClass:"language-js extra-class"},[a("pre",{pre:!0,attrs:{class:"language-js"}},[a("code",[t._v("Favor"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("findAll")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("where")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("art_id")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n      "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("Op"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("in"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" ids\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n   "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n   "),a("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("group")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'art_id'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n   "),a("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("attributes")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'art_id'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("Sequelize"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("fn")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'COUNT'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'*'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'count'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n")])])]),a("p",[t._v("求数目总和是count，求字段总和如分数用sum，第二个参数是字段名称")]),t._v(" "),a("h4",{attrs:{id:"_1-3-sequelize-实现事务"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_1-3-sequelize-实现事务"}},[t._v("#")]),t._v(" 1.3. Sequelize 实现事务")]),t._v(" "),a("div",{staticClass:"language-js extra-class"},[a("pre",{pre:!0,attrs:{class:"language-js"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" db"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("transaction")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("async")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token parameter"}},[t._v("t")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=>")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("await")]),t._v(" Favor"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("create")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    art_id"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    type"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    uid\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("transaction")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" t "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" art "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("await")]),t._v(" Art"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("getData")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("art_id"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" type"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("await")]),t._v(" art"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("increment")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'fav_nums'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("by")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("transaction")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" t "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n")])])]),a("p",[t._v("大写的"),a("code",[t._v("Favor")]),t._v("是表，小写的"),a("code",[t._v("favor")]),t._v("是表里的一条记录")]),t._v(" "),a("h4",{attrs:{id:"_1-4-allowedmethods"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_1-4-allowedmethods"}},[t._v("#")]),t._v(" 1.4. "),a("code",[t._v("allowedMethods")])]),t._v(" "),a("p",[a("code",[t._v(".allowedMethods")]),t._v("处理的业务是当所有路由中间件执行完成之后，若"),a("code",[t._v("ctx.status")]),t._v("为空或者404的时候，丰富"),a("code",[t._v("response")]),t._v("对象的"),a("code",[t._v("header")]),t._v("头。")]),t._v(" "),a("p",[t._v("如果只监听了 / 路由的 POST 方法，在浏览器中使用 GET 方法访问路由，koa 会自动设置一些 Header 并返回访问该路由的方法不被允许")]),t._v(" "),a("h4",{attrs:{id:"_1-5-注意事项"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_1-5-注意事项"}},[t._v("#")]),t._v(" 1.5. 注意事项")]),t._v(" "),a("ol",[a("li",[t._v("用户"),a("code",[t._v("id")]),t._v("不能通过参数传递，非常危险，应该通过"),a("code",[t._v("token")])]),t._v(" "),a("li",[t._v("避免循环查询数据库的方法是用"),a("code",[t._v("in")]),t._v("，即把查询的字段放到数组里。不可以用for循环，for循环不可控。")]),t._v(" "),a("li",[t._v("越主要的函数就应该越简洁，复杂逻辑要拆分。")]),t._v(" "),a("li",[t._v("A文件导入B文件，B文件导入A文件，即循环导入，会导致一个文件为"),a("code",[t._v("undefined")]),t._v("，不好排查，一个解决方法是"),a("strong",[t._v("在函数或类内部导入")])]),t._v(" "),a("li",[t._v("Model 中禁止使用构造函数")])]),t._v(" "),a("h4",{attrs:{id:"_1-6-模糊匹配"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_1-6-模糊匹配"}},[t._v("#")]),t._v(" 1.6. 模糊匹配")]),t._v(" "),a("p",[a("code",[t._v("%key%")]),t._v("，"),a("code",[t._v("mysql")]),t._v("不会使用索引，速度慢，而"),a("code",[t._v("key%")]),t._v("会使用索引，即用后面的百分号")]),t._v(" "),a("h4",{attrs:{id:"_1-7-排除字段"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_1-7-排除字段"}},[t._v("#")]),t._v(" 1.7. 排除字段")]),t._v(" "),a("ul",[a("li",[t._v("对象里面有"),a("code",[t._v("toJSON")]),t._v("方法的话，序列化结果就是"),a("code",[t._v("toJSON")]),t._v("函数返回的对象，可以用它来过滤字段。")]),t._v(" "),a("li",[t._v("在Model的原型链上添加"),a("code",[t._v("toJSON")]),t._v("方法，就不用每建立一个模型实例就手动添加"),a("code",[t._v("toJSON")]),t._v("方法了。并且添加"),a("code",[t._v("exclude")]),t._v("数组，可以简便的排除。")]),t._v(" "),a("li",[t._v("有个缺陷是只能用于"),a("code",[t._v("findOne")]),t._v("，如果是"),a("code",[t._v("findAll")]),t._v("需要在模型实例上，如"),a("code",[t._v("Comment.propotype.exclude = [‘id’]")]),t._v("进行排除。")])])])}),[],!1,null,null,null);a.default=n.exports}}]);