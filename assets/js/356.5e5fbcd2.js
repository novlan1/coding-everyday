(window.webpackJsonp=window.webpackJsonp||[]).push([[356],{630:function(t,s,_){"use strict";_.r(s);var e=_(14),a=Object(e.a)({},(function(){var t=this,s=t._self._c;return s("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[s("p",[t._v("[toc]")]),t._v(" "),s("h2",{attrs:{id:"_1-背景"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_1-背景"}},[t._v("#")]),t._v(" 1. 背景")]),t._v(" "),s("p",[t._v("基础库跨平台的方式是，在编译阶段用"),s("code",[t._v("webpack plugin")]),t._v("替换关键词，比如下面的代码：")]),t._v(" "),s("div",{staticClass:"language-ts extra-class"},[s("pre",{pre:!0,attrs:{class:"language-ts"}},[s("code",[s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// @ts-ignore")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("export")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v(" initXss "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("from")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'./index-@TIP_PLATFORM_NAME'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])])]),s("p",[t._v("在"),s("code",[t._v("web")]),t._v("端是映射到"),s("code",[t._v("index-web")]),t._v("，在小程序映射到"),s("code",[t._v("index-mp")]),t._v("。")]),t._v(" "),s("p",[t._v("这种使用方式由来已久，是早期兼容"),s("code",[t._v("hippy")]),t._v("项目时开始的。")]),t._v(" "),s("p",[t._v("这种方法的一个缺点是缺少类型提示，因为"),s("code",[t._v("ts")]),t._v("找不到"),s("code",[t._v("@TIP_PLATFORM_NAME")]),t._v("这个文件，类型就中断了，同时"),s("code",[t._v("eslint")]),t._v("默认也会报错。")]),t._v(" "),s("h2",{attrs:{id:"_2-思路"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_2-思路"}},[t._v("#")]),t._v(" 2. 思路")]),t._v(" "),s("p",[t._v("报错问题很好解决，不管是"),s("code",[t._v("eslint")]),t._v("还是"),s("code",[t._v("ts")]),t._v("，只需要设置"),s("code",[t._v("ignore")]),t._v("或"),s("code",[t._v("rule")]),t._v("以及"),s("code",[t._v("@ts-ignore")]),t._v("即可。")]),t._v(" "),s("p",[t._v("比如"),s("code",[t._v("eslint")]),t._v("额外配置下规则：")]),t._v(" "),s("div",{staticClass:"language-js extra-class"},[s("pre",{pre:!0,attrs:{class:"language-js"}},[s("code",[t._v("module"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("exports "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("rules")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token string-property property"}},[t._v("'import/no-unresolved'")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("2")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n      "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("ignore")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("\n          "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'@TIP_PLATFORM_NAME'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n      "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])])]),s("p",[t._v("但是没有类型提示就很不友好了，容易出错，效率也低。")]),t._v(" "),s("p",[t._v("如何解决呢，尝试了下面几种方案。")]),t._v(" "),s("ol",[s("li",[t._v("在"),s("code",[t._v("tsconfig.json")]),t._v("中设置"),s("code",[t._v("compilerOptions.paths")]),t._v("，类似"),s("code",[t._v("webpack")]),t._v("配置中的"),s("code",[t._v("alias")]),t._v("。")])]),t._v(" "),s("p",[t._v("但是"),s("code",[t._v("paths")]),t._v("只能指定绝对路径的别名，比如"),s("code",[t._v("@")]),t._v("、"),s("code",[t._v("@/utils")]),t._v("等，基础库基本都是相对路径，如果都改成一个特殊前缀的绝对路径，并不直观。")]),t._v(" "),s("ol",{attrs:{start:"2"}},[s("li",[t._v("写个"),s("code",[t._v("vscode插")]),t._v("件，做相关的类型提示。")])]),t._v(" "),s("p",[t._v("这种方式成本相对高，而且使用基础库的人比较多，还有一些外部团队，沟通、教育成本比较高。")]),t._v(" "),s("ol",{attrs:{start:"3"}},[s("li",[t._v("为引用方生成一份类型文件")])]),t._v(" "),s("p",[t._v("可以在同级目录下，生成一份引用者的"),s("code",[t._v(".d.ts")]),t._v("文件，比如"),s("code",[t._v("index.js")]),t._v("使用了"),s("code",[t._v("index-web")]),t._v("和"),s("code",[t._v("index-mp")]),t._v("，那么可以生成"),s("code",[t._v("index.d.ts")]),t._v("文件。这样"),s("code",[t._v("ts")]),t._v("就可以找到相应的提示了。")]),t._v(" "),s("p",[t._v("但是，这种方式有2个问题。")]),t._v(" "),s("p",[t._v("第一，引用方的错误依然无法消除，因为依然找不到"),s("code",[t._v("index-@TIP_PLATFORM_NAME")])]),t._v(" "),s("p",[t._v("第二，引用方需要用"),s("code",[t._v("js")]),t._v("编写。如果引用方是用"),s("code",[t._v("ts")]),t._v("写的，也就是"),s("code",[t._v("index.ts")]),t._v("，而不是"),s("code",[t._v("index.js")]),t._v("，那么 "),s("code",[t._v("typescript")]),t._v(" 会优先找"),s("code",[t._v("ts")]),t._v("文件，而不是"),s("code",[t._v(".d.ts")]),t._v("文件，由于"),s("code",[t._v("index.ts")]),t._v("中有找不到的依赖，也就是编译失败，那么类型提示依然会中断。")]),t._v(" "),s("ol",{attrs:{start:"4"}},[s("li",[t._v("生成"),s("code",[t._v("@TIP_PLATFORM_NAME")]),t._v("的类型文件")])]),t._v(" "),s("p",[t._v("在同级目录下，生成一份"),s("code",[t._v(".d.ts")]),t._v("文件。即使没有"),s("code",[t._v("index-@TIP_PLATFORM_NAME")]),t._v("真实的文件，但是可以有类型文件"),s("code",[t._v("index-@TIP_PLATFORM_NAME.d.ts")]),t._v("，其类型与"),s("code",[t._v("index-web")]),t._v("中导出类型一致，这样不就可以提示了吗？")]),t._v(" "),s("p",[t._v("这种方案相对上面几种方式，相对成本低、效果好，所以采用这种方案。")]),t._v(" "),s("h2",{attrs:{id:"_3-实现"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_3-实现"}},[t._v("#")]),t._v(" 3. 实现")]),t._v(" "),s("p",[t._v("搜了一下，有40多个文件用了这种“关键词编译”方法，手工写效率太低、容易出错，所以考虑用脚本。")]),t._v(" "),s("p",[t._v("脚本实现如下：")]),t._v(" "),s("ul",[s("li",[t._v("获取哪些文件使用了关键词"),s("code",[t._v("@TIP_PLATFORM_NAME")])]),t._v(" "),s("li",[t._v("查找对应的"),s("code",[t._v("xxx-web")]),t._v("的路径，注意并不一定是同级，有可能是子文件夹")]),t._v(" "),s("li",[t._v("生成"),s("code",[t._v("xxx-web")]),t._v("的类型文件")]),t._v(" "),s("li",[t._v("将上面类型文件名更新为"),s("code",[t._v("xxx-@TIP_PLATFORM_NAME.d.ts")])])]),t._v(" "),s("h2",{attrs:{id:"_4-效果对比"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_4-效果对比"}},[t._v("#")]),t._v(" 4. 效果对比")]),t._v(" "),s("p",[t._v("使用前：")]),t._v(" "),s("img",{attrs:{src:"https://mike-1255355338.cos.ap-guangzhou.myqcloud.com/article/2023/8/own_mike_4f2d63a6e4ad086aa2.jpg",width:"600"}}),t._v(" "),s("p",[t._v("使用后：")]),t._v(" "),s("img",{attrs:{src:"https://mike-1255355338.cos.ap-guangzhou.myqcloud.com/article/2023/8/own_mike_efa2ea96c0d2e579d6.jpg",width:"600"}}),t._v(" "),s("h2",{attrs:{id:"_5-后记"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_5-后记"}},[t._v("#")]),t._v(" 5. 后记")]),t._v(" "),s("p",[t._v("其实解决跨平台编译有更好的解决方案，比如"),s("code",[t._v("uni-app")]),t._v("中的"),s("a",{attrs:{href:"https://uniapp.dcloud.net.cn/tutorial/platform.html#preprocessor",target:"_blank",rel:"noopener noreferrer"}},[t._v("条件编译"),s("OutboundLink")],1),t._v("，小程序的"),s("a",{attrs:{href:"https://dev.weixin.qq.com/docs/framework/dev/framework/operation/condition-compile.html",target:"_blank",rel:"noopener noreferrer"}},[t._v("条件编译"),s("OutboundLink")],1),t._v("。")]),t._v(" "),s("p",[t._v('相比于上面的“关键词编译”，条件编译更加灵活。"关键词编译"必须把差异部分提取到一个文件中，而条件编译可以解决任意粒度的差异，可以是文件级别，也可以是几行代码，比如：')]),t._v(" "),s("div",{staticClass:"language-ts extra-class"},[s("pre",{pre:!0,attrs:{class:"language-ts"}},[s("code",[s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// #ifdef H5")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("console")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("log")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'only H5'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// #endif")]),t._v("\n")])])]),s("p",[t._v("另外，使用关键词编译意味着必须引入一个额外的工具（"),s("code",[t._v("loader")]),t._v("），而条件编译时是注释方式，可以引入"),s("code",[t._v("loader")]),t._v("，也可以不用，更灵活。")]),t._v(" "),s("p",[t._v("但是"),s("code",[t._v("uni-app")]),t._v("的条件编译只能用在基于"),s("code",[t._v("uni-app")]),t._v("的项目中，对于普通的前端项目，如何实现同样的条件编译呢？")]),t._v(" "),s("p",[t._v("这里我写了一个"),s("a",{attrs:{href:"https://github.com/novlan1/uni-plugin-light/tree/master/src/loader/ifdef-loader",target:"_blank",rel:"noopener noreferrer"}},[t._v("webpack loader"),s("OutboundLink")],1),t._v("，可以实现相同效果，使用方式也与"),s("code",[t._v("uni-app")]),t._v("相同。")])])}),[],!1,null,null,null);s.default=a.exports}}]);