(window.webpackJsonp=window.webpackJsonp||[]).push([[387],{655:function(t,s,a){"use strict";a.r(s);var e=a(14),n=Object(e.a)({},(function(){var t=this,s=t._self._c;return s("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[s("h2",{attrs:{id:"_1-开始"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_1-开始"}},[t._v("#")]),t._v(" 1. 开始")]),t._v(" "),s("p",[t._v("遇到一个比较大的项目从 "),s("code",[t._v("Vue2")]),t._v(" 的 "),s("code",[t._v("uni-app")]),t._v(" 迁移到 "),s("code",[t._v("Vue3")]),t._v("，主包大小又超了，在组件分发的基础上，做了脚本分发，这里简单记录下。")]),t._v(" "),s("p",[t._v("脚本分发就是把只有分包使用的"),s("code",[t._v("js/ts")]),t._v("等放到对应的分包，而不是基于目录位置。")]),t._v(" "),s("h2",{attrs:{id:"_2-实现"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_2-实现"}},[t._v("#")]),t._v(" 2. 实现")]),t._v(" "),s("h3",{attrs:{id:"_2-1-默认打包策略"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_2-1-默认打包策略"}},[t._v("#")]),t._v(" 2.1. 默认打包策略")]),t._v(" "),s("p",[s("code",[t._v("uni-app")]),t._v(" "),s("code",[t._v("Vue3")]),t._v(" 版本默认打包策略如下:")]),t._v(" "),s("ol",[s("li",[s("code",[t._v("assets")]),t._v(" 文件，比如 "),s("code",[t._v("png/pdf/ttf")]),t._v(" 等文件，放到 "),s("code",[t._v("common/assets")])]),t._v(" "),s("li",[t._v("项目内 "),s("code",[t._v("js/ts")]),t._v("，但不是 "),s("code",[t._v("page/component")]),t._v(" 对应的文件，"),s("strong",[t._v("放到相对目录位置")])]),t._v(" "),s("li",[t._v("项目外 "),s("code",[t._v("js/ts")]),t._v(" 放到 "),s("code",[t._v("common/vendor")])]),t._v(" "),s("li",[s("code",[t._v("isVueJs")]),t._v(" 文件，放到 "),s("code",[t._v("common/vendor")])]),t._v(" "),s("li",[s("code",[t._v("node_modules")]),t._v(" 下非 "),s("code",[t._v("js/ts/css")]),t._v(" 文件，并且是入口文件（"),s("code",[t._v("getModuleInfo(id).isEntry")]),t._v(" 为 "),s("code",[t._v("true")]),t._v("），放到 "),s("code",[t._v("common/vendor")])])]),t._v(" "),s("p",[t._v("源码位置："),s("code",[t._v("packages/uni-mp-vite/src/plugin/build.ts")]),t._v("。")]),t._v(" "),s("div",{staticClass:"language-ts extra-class"},[s("pre",{pre:!0,attrs:{class:"language-ts"}},[s("code",[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("function")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("createMoveToVendorChunkFn")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" GetManualChunk "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" cache "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("new")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Map"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),s("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("string")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("boolean")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")])]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" inputDir "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("normalizePath")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("process"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("env"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token constant"}},[t._v("UNI_INPUT_DIR")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("id"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v(" getModuleInfo "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=>")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" normalizedId "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("normalizePath")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("id"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" filename "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" normalizedId"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("split")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'?'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 处理资源文件")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token constant"}},[t._v("DEFAULT_ASSETS_RE")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("test")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("filename"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n      "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'common/assets'")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 处理项目内的js,ts文件")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token constant"}},[t._v("EXTNAME_JS_RE")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("test")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("filename"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n      "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("filename"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("startsWith")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("inputDir"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("&&")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("!")]),t._v("filename"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("includes")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'node_modules'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" chunkFileName "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("removeExt")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("\n          "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("normalizePath")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("path"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("relative")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("inputDir"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" filename"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("\n          "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("!")]),t._v("chunkFileNameBlackList"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("includes")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("chunkFileName"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("&&")]),t._v("\n          "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("!")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("hasJsonFile")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("chunkFileName"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 无同名的page,component")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n          "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" chunkFileName\n        "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v("\n      "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n      "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 非项目内的 js 资源，均打包到 vendor")]),t._v("\n      "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'common/vendor'")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("\n      "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("isVueJs")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("normalizedId"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("||")]),t._v("\n      "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("normalizedId"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("includes")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'node_modules'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("&&")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("!")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("isCSSRequest")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("normalizedId"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("&&")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 使用原始路径，格式化的可能找不到模块信息 https://github.com/dcloudio/uni-app/issues/3425")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("staticImportedByEntry")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("id"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" getModuleInfo"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" cache"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n      "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'common/vendor'")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),s("p",[t._v("相比于 "),s("code",[t._v("Vue2")]),t._v(" 版本，有几个不同：")]),t._v(" "),s("ol",[s("li",[t._v("基于目录位置进行打包")]),t._v(" "),s("li",[t._v("不存在分包的 "),s("code",[t._v("common/vendor")])]),t._v(" "),s("li",[t._v("公共目录下的文件，即使只有1个子包使用，也是放到主包中，即 "),s("code",[t._v("common/vendor")])])]),t._v(" "),s("p",[s("code",[t._v("Vue2")]),t._v(" 版本的"),s("a",{attrs:{href:"https://zh.uniapp.dcloud.io/collocation/manifest.html#%E5%85%B3%E4%BA%8E%E5%88%86%E5%8C%85%E4%BC%98%E5%8C%96%E7%9A%84%E8%AF%B4%E6%98%8E",target:"_blank",rel:"noopener noreferrer"}},[t._v("分包优化"),s("OutboundLink")],1),t._v("说明。")]),t._v(" "),s("h3",{attrs:{id:"_2-2-项目遗留问题"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_2-2-项目遗留问题"}},[t._v("#")]),t._v(" 2.2. 项目遗留问题")]),t._v(" "),s("p",[t._v("调试发现上面代码里的 "),s("code",[t._v("process.env.UNI_INPUT_DIR")]),t._v(" 也就是 "),s("code",[t._v("inputDir")]),t._v(" ，在我们项目中是相对路径，比如 "),s("code",[t._v("src/project/user")]),t._v("，而插件内的 "),s("code",[t._v("filename")]),t._v(" 是绝对路径，导致 "),s("code",[t._v("filename.startsWith(inputDir)")]),t._v(" 一定为 "),s("code",[t._v("false")]),t._v("，从而让所有文件都放到 "),s("code",[t._v("common-vendor")]),t._v(" 中。")]),t._v(" "),s("p",[t._v("而 "),s("code",[t._v("uni-app")]),t._v(" 官方 "),s("code",[t._v("demo")]),t._v(" 中 "),s("code",[t._v("process.env.UNI_INPUT_DIR")]),t._v(" 其实是绝对路径，我们项目是 "),s("code",[t._v("monorepo")]),t._v("，所以是覆盖了这个变量。")]),t._v(" "),s("p",[t._v("另外，项目中有大量依赖混乱的问题：")]),t._v(" "),s("ul",[s("li",[t._v("主包引用子包")]),t._v(" "),s("li",[t._v("子包引用其他子包")])]),t._v(" "),s("p",[t._v("如果强行改成绝对路径，会导致引用错误。比如 "),s("code",[t._v("src/project/user/views/sche/logic/reset-sche.js")]),t._v("，按照上面的规则，是打包到 "),s("code",[t._v("views/sche/logic/reset-sche.js")]),t._v(" 位置。但是它又被主包的JS引用，形成了循坏依赖。")]),t._v(" "),s("ol",[s("li",[t._v("主包JS打包成 "),s("code",[t._v("common/vendor")]),t._v("，依赖 "),s("code",[t._v("views/sche/logic/reset-sche.js")])]),t._v(" "),s("li",[s("code",[t._v("views/sche/logic/reset-sche.js")]),t._v(" 打包成 "),s("code",[t._v("views/sche/logic/reset-sche.js")]),t._v("，引用主包内其他JS，即依赖 "),s("code",[t._v("common/vendor")])])]),t._v(" "),s("p",[t._v("报错信息：")]),t._v(" "),s("img",{attrs:{src:"https://mike-1255355338.cos.ap-guangzhou.myqcloud.com/article/2024/11/own_mike_d0f6532827b3cd18db.png",width:"500"}}),t._v(" "),s("p",[t._v("common/vendor 相关内容：")]),t._v(" "),s("img",{attrs:{src:"https://mike-1255355338.cos.ap-guangzhou.myqcloud.com/article/2024/11/own_mike_c02d488b4f5347989d.png",width:"500"}}),t._v(" "),s("p",[s("code",[t._v("views/sche/logic/reset-sche.js")]),t._v(" 相关内容：")]),t._v(" "),s("img",{attrs:{src:"https://mike-1255355338.cos.ap-guangzhou.myqcloud.com/article/2024/11/own_mike_a9299e602389d6fbb3.png",width:"500"}}),t._v(" "),s("h3",{attrs:{id:"_2-3-最佳出路"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_2-3-最佳出路"}},[t._v("#")]),t._v(" 2.3. 最佳出路")]),t._v(" "),s("p",[s("strong",[t._v("修改 "),s("code",[t._v("process.env.UNI_INPUT_DIR")]),t._v(" 为绝对路径，并梳理项目代码，杜绝错误依赖问题，是减包的最佳出路")]),t._v("。")]),t._v(" "),s("p",[t._v("但今天不介绍这个，介绍的是脚本分发。我们想下，即使我们的依赖梳理很清楚了，一些模块依然不得不放到公共路径，比如它可能是第三方依赖，"),s("code",[t._v("node_modules")]),t._v("下的内容。如何将它打到分包中呢？")]),t._v(" "),s("h3",{attrs:{id:"_2-4-脚本分发"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_2-4-脚本分发"}},[t._v("#")]),t._v(" 2.4. 脚本分发")]),t._v(" "),s("p",[t._v("脚本分发插件主要工作都在 "),s("code",[t._v("build.rollupOptions.output.manualChunks")]),t._v(" 配置中进行。")]),t._v(" "),s("ol",[s("li",[t._v("根据 "),s("code",[t._v("id/getModuleInfo")]),t._v(" 等获取依赖关系")]),t._v(" "),s("li",[t._v("判断最终使用者只有一个分包，就打到分包中")])]),t._v(" "),s("p",[t._v("如何获取依赖关系：")]),t._v(" "),s("ol",[s("li",[t._v("涉及两个核心概念，"),s("code",[t._v("importers")]),t._v(" 和 "),s("code",[t._v("dynamicImporters")]),t._v("，前者是引用者，后者是动态引用者")]),t._v(" "),s("li",[t._v("小程序中并没有真正的动态引用，可以认为是 "),s("code",[t._v("uni-app")]),t._v(" 巧妙了利用这个字段记录了组件的依赖关系")]),t._v(" "),s("li",[s("code",[t._v("getModuleInfo")]),t._v(" 会返回 "),s("code",[t._v("importers")]),t._v(" 和 "),s("code",[t._v("dynamicImporters")]),t._v("，向上递归就能获取到完整的依赖关系")])]),t._v(" "),s("p",[t._v("与组件分发中收集依赖的差别：")]),t._v(" "),s("ol",[s("li",[t._v("组件分发中能拿到整个"),s("code",[t._v("bundle")]),t._v("，脚本分发中只能拿到自己以及父节点")]),t._v(" "),s("li",[t._v("可以认为"),s("strong",[t._v("组件分发能拿到整棵树，脚本分发只能拿到一个树枝")])])]),t._v(" "),s("p",[s("code",[t._v("uni-app")]),t._v(" 对组件有特殊处理：")]),t._v(" "),s("ol",[s("li",[t._v("特殊处理指的是将组件在"),s("code",[t._v("load")]),t._v("和"),s("code",[t._v("transform")]),t._v("时进行了"),s("strong",[t._v("虚拟化")])]),t._v(" "),s("li",[t._v("推测是为了简化打包处理，比如不用考虑打到"),s("code",[t._v("vendor")]),t._v("，断开与JS的引用关系。")]),t._v(" "),s("li",[s("strong",[t._v("虚拟组件以 "),s("code",[t._v("uniComponent://")]),t._v(" 开头，虚拟页面以 "),s("code",[t._v("uniPage://")]),t._v(" 开头，并都进行了 "),s("code",[t._v("base64")]),t._v(" 编码")])]),t._v(" "),s("li",[t._v("用 "),s("code",[t._v("base64")]),t._v(" 编码的好处是，可以无损解码")])]),t._v(" "),s("p",[s("code",[t._v("uni-app")]),t._v(" 中组件的引用关系：")]),t._v(" "),s("ol",[s("li",[s("code",[t._v("importers")]),t._v(" 关系: JS => [组件A, 其他] => [虚拟组件A]")]),t._v(" "),s("li",[s("strong",[s("code",[t._v("dynamicImporters")]),t._v(" 关系: 虚拟组件A => [组件B, 其他]")])]),t._v(" "),s("li",[s("strong",[s("code",[t._v("importers")]),t._v(" 关系: 组件B => [虚拟组件B]")])]),t._v(" "),s("li",[s("code",[t._v("dynamicImporters")]),t._v(" 关系: 虚拟组件B => [组件C, 其他]")]),t._v(" "),s("li",[s("code",[t._v("importers")]),t._v(" 关系: ...")])]),t._v(" "),s("p",[t._v("从上面可以看到，涉及到组件的，就会转为虚拟组件，"),s("strong",[t._v("要找组件的引用关系，就是找对应虚拟组件的 "),s("code",[t._v("dynamicImporters")])]),t._v("。")]),t._v(" "),s("p",[t._v("递归寻找引用者时需要注意：")]),t._v(" "),s("ol",[s("li",[t._v("缓存节点，避免重复寻找")]),t._v(" "),s("li",[t._v("注意循环引用，"),s("strong",[t._v("遇到循环引用的一律当成主包内容")]),t._v("，不处理，避免出错")])]),t._v(" "),s("p",[t._v("基本上找到这个树枝，就完成大部分工作了，剩下的是寻找分包：")]),t._v(" "),s("ol",[s("li",[t._v("被 "),s("code",[t._v("main.ts/App.vue")]),t._v(" 使用了，返回主包")]),t._v(" "),s("li",[t._v("被主包页面使用了，返回主包")]),t._v(" "),s("li",[t._v("被分包页面使用了，返回分包")]),t._v(" "),s("li",[s("strong",[t._v("被分包组件使用了，也返回分包")])])]),t._v(" "),s("p",[t._v("全部分析完后，就能筛选出哪些需要分发了，返回一个合成的子包路径即可。")]),t._v(" "),s("div",{staticClass:"language-ts extra-class"},[s("pre",{pre:!0,attrs:{class:"language-ts"}},[s("code",[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" targetName "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token template-string"}},[s("span",{pre:!0,attrs:{class:"token template-punctuation string"}},[t._v("`")]),s("span",{pre:!0,attrs:{class:"token interpolation"}},[s("span",{pre:!0,attrs:{class:"token interpolation-punctuation punctuation"}},[t._v("${")]),t._v("subPackages"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token interpolation-punctuation punctuation"}},[t._v("}")])]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("/")]),s("span",{pre:!0,attrs:{class:"token interpolation"}},[s("span",{pre:!0,attrs:{class:"token interpolation-punctuation punctuation"}},[t._v("${")]),t._v("dispatchDir"),s("span",{pre:!0,attrs:{class:"token interpolation-punctuation punctuation"}},[t._v("}")])]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("/")]),s("span",{pre:!0,attrs:{class:"token interpolation"}},[s("span",{pre:!0,attrs:{class:"token interpolation-punctuation punctuation"}},[t._v("${")]),t._v("dispatchChunkFileName"),s("span",{pre:!0,attrs:{class:"token interpolation-punctuation punctuation"}},[t._v("}")])]),s("span",{pre:!0,attrs:{class:"token template-punctuation string"}},[t._v("`")])]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])])]),s("h2",{attrs:{id:"_3-效果"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_3-效果"}},[t._v("#")]),t._v(" 3. 效果")]),t._v(" "),s("p",[t._v("使用后能减少 "),s("code",[t._v("130KB")]),t._v("。")]),t._v(" "),s("img",{attrs:{src:"https://mike-1255355338.cos.ap-guangzhou.myqcloud.com/article/2024/11/own_mike_649de2fcc66b512bb3.png",width:"500"}}),t._v(" "),s("img",{attrs:{src:"https://mike-1255355338.cos.ap-guangzhou.myqcloud.com/article/2024/11/own_mike_c0afad5ba87391b28d.png",width:"500"}}),t._v(" "),s("h2",{attrs:{id:"_4-感悟"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_4-感悟"}},[t._v("#")]),t._v(" 4. 感悟")]),t._v(" "),s("blockquote",[s("p",[t._v("你如果深刻理解它，你就会把代码写的又简单、又直接、又没有bug、性能又好，你如果不理解它，你就会把代码写的又臭又长，bug又多，又难维护、难理解。")]),t._v(" "),s("p",[t._v("有时候，越快完成，写得越好，越慢完成，写得越差")])]),t._v(" "),s("h2",{attrs:{id:"_5-参考"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_5-参考"}},[t._v("#")]),t._v(" 5. 参考")]),t._v(" "),s("ol",[s("li",[t._v("https://juejin.cn/post/7135671174893142030")]),t._v(" "),s("li",[t._v("https://github.com/sanyuan0704/vite-plugin-chunk-split/blob/master/README-CN.md")])]),t._v(" "),s("hr"),t._v(" "),s("p",[t._v("分割线，后面聊聊依赖关系")]),t._v(" "),s("hr"),t._v(" "),s("h2",{attrs:{id:"_6-依赖关系"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_6-依赖关系"}},[t._v("#")]),t._v(" 6. 依赖关系")]),t._v(" "),s("p",[t._v("有几种引用错误")]),t._v(" "),s("ol",[s("li",[t._v("主包引用子包")]),t._v(" "),s("li",[t._v("子包引用其他子包")]),t._v(" "),s("li",[t._v("循环依赖")]),t._v(" "),s("li",[t._v("JS/TS 引用 Vue 文件（小程序下）")])]),t._v(" "),s("p",[t._v("脚本分发插件可以分析依赖，能输出前三种错误信息，帮助开发者快速定位问题\n。")]),t._v(" "),s("hr"),t._v(" "),s("p",[t._v("分割线，后面聊聊 uni-app 的路由")]),t._v(" "),s("hr"),t._v(" "),s("h2",{attrs:{id:"_7-路由"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_7-路由"}},[t._v("#")]),t._v(" 7. 路由")]),t._v(" "),s("h3",{attrs:{id:"_7-1-uni-app-中的路由"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_7-1-uni-app-中的路由"}},[t._v("#")]),t._v(" 7.1. uni-app 中的路由")]),t._v(" "),s("h4",{attrs:{id:"_7-1-1-h5-vue3"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_7-1-1-h5-vue3"}},[t._v("#")]),t._v(" 7.1.1. H5（Vue3）")]),t._v(" "),s("ol",[s("li",[s("code",[t._v("uni-app")]),t._v(" 内部也是用的 "),s("code",[t._v("vue-router")]),t._v("，能找到 "),s("code",[t._v("createRouter")]),t._v(" API的调用")]),t._v(" "),s("li",[s("code",[t._v("createRouter")]),t._v(" 中 "),s("code",[t._v("routes")]),t._v(" 参数使用的是 "),s("code",[t._v("__uniRoutes")]),t._v("，这是 "),s("code",[t._v("uni-app")]),t._v(" 内部变量，有 "),s("code",[t._v("path/alias/meta/loader/component")]),t._v(" 几个属性。直接在控制台打印 "),s("code",[t._v("window.__uniRoutes")]),t._v(" 就能看到")]),t._v(" "),s("li",[s("code",[t._v("createRouter")]),t._v(" 源码路径："),s("code",[t._v("packages/uni-h5-vite/src/plugins/pagesJson.ts")]),t._v("，或搜索 "),s("code",[t._v("generatePagesRoute")])]),t._v(" "),s("li",[s("code",[t._v("__uniRoutes")]),t._v(" 都没有 "),s("code",[t._v("name")]),t._v(" 属性，自然无法通过 "),s("code",[t._v("name")]),t._v(" 跳转，即 "),s("code",[t._v("$router.push({ name: 'xxx' })")]),t._v(" 不可行，只能通过 "),s("code",[t._v("path")]),t._v(" 跳转")])]),t._v(" "),s("h4",{attrs:{id:"_7-1-2-h5-vue2"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_7-1-2-h5-vue2"}},[t._v("#")]),t._v(" 7.1.2. H5（Vue2）")]),t._v(" "),s("ol",[s("li",[t._v("同样用的 "),s("code",[t._v("vue-router")])]),t._v(" "),s("li",[t._v("Vue2 中 "),s("code",[t._v("__uniRoutes")]),t._v(" 的生成逻辑源码在："),s("code",[t._v("packages/webpack-uni-pages-loader/lib/platforms/h5.js")]),t._v("，或搜索 "),s("code",[t._v("genPageRoutes")])])]),t._v(" "),s("h4",{attrs:{id:"_7-1-3-非-h5"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_7-1-3-非-h5"}},[t._v("#")]),t._v(" 7.1.3. 非 H5")]),t._v(" "),s("p",[s("code",[t._v("uni-app")]),t._v(" 在非H5端没有提供 "),s("code",[t._v("$router")]),t._v("，推荐直接使用 "),s("code",[t._v("uni.navigateTo")]),t._v(" 等原生语法。")]),t._v(" "),s("h3",{attrs:{id:"_7-2-h5中路由的多样性"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_7-2-h5中路由的多样性"}},[t._v("#")]),t._v(" 7.2. H5中路由的多样性")]),t._v(" "),s("p",[t._v("路由有3种形式")]),t._v(" "),s("ol",[s("li",[t._v("动态路由，比如 "),s("code",[t._v("/match/match-detail/52973147")])]),t._v(" "),s("li",[s("code",[t._v("aliasPath + query")]),t._v("，"),s("code",[t._v("aliasPath")]),t._v(" 就是路径别名，比如 "),s("code",[t._v("/match-list?siteId=2066002")])]),t._v(" "),s("li",[s("code",[t._v("fullPath + query")]),t._v("，"),s("code",[t._v("fullPath")]),t._v(" 就是全部路径，比如 "),s("code",[t._v("views/match-list/match-list?siteId=2066002")])])]),t._v(" "),s("p",[t._v("非 "),s("code",[t._v("uni-app")]),t._v(" 项目我更倾向于用1，参数精炼。"),s("code",[t._v("uni-app")]),t._v(" 项目我更倾向于用3，好处有：")]),t._v(" "),s("ol",[s("li",[t._v("多端统一，无需额外兼容、转化")]),t._v(" "),s("li",[t._v("所见即所得，无心智负担")])]),t._v(" "),s("p",[t._v("路由有两种模式，"),s("code",[t._v("hash")]),t._v(" 和 "),s("code",[t._v("history")]),t._v("，结合上面提到的3种形式，总共有 "),s("code",[t._v("2 * 3 = 6")]),t._v(" 种类型。")]),t._v(" "),s("h3",{attrs:{id:"_7-3-命名路由"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_7-3-命名路由"}},[t._v("#")]),t._v(" 7.3. 命名路由")]),t._v(" "),s("p",[t._v("毫无疑问，命名路由有"),s("a",{attrs:{href:"https://router.vuejs.org/zh/guide/essentials/named-routes.html",target:"_blank",rel:"noopener noreferrer"}},[t._v("很多好处"),s("OutboundLink")],1),t._v("，比如没有硬编码，不会担心打错 "),s("code",[t._v("path")]),t._v("。")]),t._v(" "),s("p",[t._v("但是考虑到统一性，新项目还是建议直接用 "),s("code",[t._v("path")]),t._v("。")]),t._v(" "),s("h3",{attrs:{id:"_7-4-重定向"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_7-4-重定向"}},[t._v("#")]),t._v(" 7.4. 重定向")]),t._v(" "),s("p",[t._v("非跨端转跨端，以及 vue2 升级 vue3，都会遇到映射路由表的问题。当前实现了：")]),t._v(" "),s("ol",[s("li",[s("code",[t._v("hash + dynamic")]),t._v(" => "),s("code",[t._v("history + aliasPath query")]),t._v("，如 "),s("code",[t._v("/#/match-detail/123 => /match-detail?childId=123")])]),t._v(" "),s("li",[s("code",[t._v("history + aliasPath query")]),t._v(" => "),s("code",[t._v("history + fullPath query")]),t._v("，如 "),s("code",[t._v("/match-detail?childId=123 => /match/match-detail?childId=123")])])]),t._v(" "),s("p",[t._v("其他几种类似。")]),t._v(" "),s("h3",{attrs:{id:"_7-5-动态路由"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_7-5-动态路由"}},[t._v("#")]),t._v(" 7.5. 动态路由")]),t._v(" "),s("p",[t._v("是 "),s("code",[t._v("uni-simple-router")]),t._v(" 支持的动态路由，"),s("code",[t._v("uni-app")]),t._v("框架本身不支持，具体是在初始化的时候，在 "),s("code",[t._v("routes")]),t._v(" 中定义了 "),s("code",[t._v("aliasPath")]),t._v("。")]),t._v(" "),s("p",[t._v("uni-app 使用 "),s("code",[t._v("vue-router")]),t._v(" 时，传入的还是 "),s("code",[t._v("path")]),t._v("，即页面路径，这种无法支持动态路由。这一点可以通过打印 "),s("code",[t._v("window.__uniRoutes")]),t._v(" 看出。引入 "),s("code",[t._v("uni-simple-router")]),t._v(" 后，再打印 "),s("code",[t._v("window.__uniRoutes")]),t._v("，会发现 "),s("code",[t._v("path")]),t._v(" 变成了动态路由，比如 "),s("code",[t._v("/match/match-detail/:childid")]),t._v("，这是 "),s("code",[t._v("uni-simple-router")]),t._v(" 中 "),s("code",[t._v("src/H5/buildRouter.ts")]),t._v(" 做的，将 "),s("code",[t._v("aliasPath")]),t._v(" 赋值给了 "),s("code",[t._v("path")]),t._v("。")])])}),[],!1,null,null,null);s.default=n.exports}}]);