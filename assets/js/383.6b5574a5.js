(window.webpackJsonp=window.webpackJsonp||[]).push([[383],{687:function(t,s,a){"use strict";a.r(s);var e=a(25),n=Object(e.a)({},(function(){var t=this,s=t._self._c;return s("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[s("h2",{attrs:{id:"_1-开始"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_1-开始"}},[t._v("#")]),t._v(" 1. 开始")]),t._v(" "),s("p",[t._v("有人在 "),s("code",[t._v("github")]),t._v(" 上提了 "),s("a",{attrs:{href:"https://github.com/Tencent/tdesign-miniprogram/issues/2840",target:"_blank",rel:"noopener noreferrer"}},[t._v("issue"),s("OutboundLink")],1),t._v("，说 "),s("code",[t._v("Cascader")]),t._v(" 在4级地址下卡顿明显。")]),t._v(" "),s("img",{attrs:{src:"https://mike-1255355338.cos.ap-guangzhou.myqcloud.com/article/2024/6/own_mike_f816e0f537c5e292a0.png",width:"700"}}),t._v(" "),s("h2",{attrs:{id:"_2-解决"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_2-解决"}},[t._v("#")]),t._v(" 2. 解决")]),t._v(" "),s("p",[t._v("看了下代码，"),s("code",[t._v("CasCader")]),t._v(" 组件会接收 "),s("code",[t._v("options")]),t._v(" 参数，大致结构如下：")]),t._v(" "),s("div",{staticClass:"language-ts extra-class"},[s("pre",{pre:!0,attrs:{class:"language-ts"}},[s("code",[s("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("Array")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v(" label"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("string")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" value"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("string")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" children"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("?")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("Array")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v("IOptions"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v("\n")])])]),s("p",[t._v("内部有个 "),s("code",[t._v("items")]),t._v("，会在渲染层循环，生成 "),s("code",[t._v("Cascader")]),t._v(" 待选择的列表，比如4级地址，"),s("code",[t._v("items")]),t._v(" 就有4项。")]),t._v(" "),s("p",[t._v("问题就出在 "),s("code",[t._v("items")]),t._v(" 的 "),s("code",[t._v("setData")]),t._v(" 上，原来的代码会在 "),s("code",[t._v("select")]),t._v(" 时，把 "),s("code",[t._v("item.children")]),t._v(" 一起设置，这其实是没有必要的，渲染层根本用不到。"),s("strong",[t._v("而且这个 "),s("code",[t._v("children")]),t._v(" 数据量巨大，而且会嵌套，"),s("code",[t._v("children")]),t._v(" 里面还有 "),s("code",[t._v("children")]),t._v("，导致 "),s("code",[t._v("setData")]),t._v(" 能达到好几兆")]),t._v("。")]),t._v(" "),s("p",[t._v("此外，取值 "),s("code",[t._v("item")]),t._v(" 的时候，完全可以从原始数据 "),s("code",[t._v("options")]),t._v(" 上，根据 "),s("code",[t._v("selectedIndexes")]),t._v(" 和 "),s("code",[t._v("level")]),t._v(" 获取。")]),t._v(" "),s("p",[t._v("直接看代码：")]),t._v(" "),s("div",{staticClass:"language-ts extra-class"},[s("pre",{pre:!0,attrs:{class:"language-ts"}},[s("code",[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("type")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("KeysType")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" TdCascaderProps"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'keys'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'value'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("function")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("parseOptions")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("options"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" OptionsType"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" keys"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" KeysType"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" label "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" keys"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("?.")]),t._v("label "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("??")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'label'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" value "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" keys"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("?.")]),t._v("value "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("??")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'value'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n  "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" options"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("map")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("item"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=>")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n      "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("label"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" item"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("label"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n      "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("value"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" item"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("value"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),s("img",{attrs:{src:"https://mike-1255355338.cos.ap-guangzhou.myqcloud.com/article/2024/6/own_mike_f3d4bd1f53b29f1c66.png",width:"800"}}),t._v(" "),s("img",{attrs:{src:"https://mike-1255355338.cos.ap-guangzhou.myqcloud.com/article/2024/6/own_mike_94b325272bbeb25cbe.png",width:"800"}}),t._v(" "),s("h2",{attrs:{id:"_3-效果"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_3-效果"}},[t._v("#")]),t._v(" 3. 效果")]),t._v(" "),s("p",[t._v("优化前：")]),t._v(" "),s("img",{attrs:{src:"https://mike-1255355338.cos.ap-guangzhou.myqcloud.com/article/2024/6/own_mike_90136e5a2f9582c59f.gif",width:"399"}}),t._v(" "),s("p",[t._v("优化后：")]),t._v(" "),s("img",{attrs:{src:"https://mike-1255355338.cos.ap-guangzhou.myqcloud.com/article/2024/6/own_mike_733b0e9743fe66dc10.gif",width:"399"}}),t._v(" "),s("h2",{attrs:{id:"_4-进一步优化"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_4-进一步优化"}},[t._v("#")]),t._v(" 4. 进一步优化")]),t._v(" "),s("p",[t._v("进一步优化了两个方面:")]),t._v(" "),s("ol",[s("li",[t._v("将 "),s("code",[t._v("options")]),t._v(" 设为纯数据字段")]),t._v(" "),s("li",[s("code",[t._v("handleSelect")]),t._v(" 时切片更新 "),s("code",[t._v("items")]),t._v("，就是更新 "),s("code",[t._v("items")]),t._v(" 的某一列，而不是一起更新。")])]),t._v(" "),s("p",[t._v("第 1 个就是新增了 "),s("code",[t._v("pureDataPattern")]),t._v("，如下：")]),t._v(" "),s("div",{staticClass:"language-ts extra-class"},[s("pre",{pre:!0,attrs:{class:"language-ts"}},[s("code",[t._v("options"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" WechatMiniprogram"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("Component"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("ComponentOptions "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  multipleSlots"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("true")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 新增")]),t._v("\n  pureDataPattern"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token regex"}},[s("span",{pre:!0,attrs:{class:"token regex-delimiter"}},[t._v("/")]),s("span",{pre:!0,attrs:{class:"token regex-source language-regex"}},[t._v("^options$")]),s("span",{pre:!0,attrs:{class:"token regex-delimiter"}},[t._v("/")])]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])])]),s("p",[t._v("第 2 个，我把 "),s("code",[t._v("options")]),t._v(" 和 "),s("code",[t._v("selectedIndexes")]),t._v(" 的监听分开，因为 "),s("code",[t._v("options")]),t._v(" 变化依然需要全量更新 "),s("code",[t._v("items")]),t._v("，而 "),s("code",[t._v("selectedIndexes")]),t._v(" 变化并不需要。")]),t._v(" "),s("p",[s("code",[t._v("handleSelect")]),t._v(" 时只需要更新 "),s("code",[t._v("items[level + 1]")]),t._v(" 即可。直接看代码。")]),t._v(" "),s("img",{attrs:{src:"https://mike-1255355338.cos.ap-guangzhou.myqcloud.com/article/2024/6/own_mike_9396b3f80bb20f18f8.png",width:"800"}}),t._v(" "),s("img",{attrs:{src:"https://mike-1255355338.cos.ap-guangzhou.myqcloud.com/article/2024/6/own_mike_c626f7f26692a2063b.png",width:"800"}}),t._v(" "),s("h2",{attrs:{id:"_5-总结"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_5-总结"}},[t._v("#")]),t._v(" 5. 总结")]),t._v(" "),s("p",[t._v("核心就两步，"),s("strong",[t._v("一是 "),s("code",[t._v("setData")]),t._v(" 的时候少更新一点，二是取的时候稍微不那么方便一点")]),t._v("。仔细想一想，是不是其他业务的性能优化也是异曲同工？")]),t._v(" "),s("p",[t._v("详细代码见"),s("a",{attrs:{href:"https://github.com/Tencent/tdesign-miniprogram/pull/2866",target:"_blank",rel:"noopener noreferrer"}},[t._v("PR"),s("OutboundLink")],1),t._v("。")]),t._v(" "),s("h2",{attrs:{id:"_6-后记"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_6-后记"}},[t._v("#")]),t._v(" 6. 后记")]),t._v(" "),s("p",[t._v("本来我都把这篇文章删了，后来看到《团队分拆了，项目怎么办》中提到了这个 "),s("code",[t._v("issue")]),t._v("，呵呵，不想多说了。")])])}),[],!1,null,null,null);s.default=n.exports}}]);