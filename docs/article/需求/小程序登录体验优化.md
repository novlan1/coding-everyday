## 1. 开始

什么是用户体验呢？一个字，爽，具体点就是，简单、自然、流畅。

基础体验优化是最重要的，之前的小程序登录体验较差，有明显的刷新页面过程，用户会感觉到页面在闪烁。

## 2. 优化

先说下之前的逻辑。前端请求后台接口，后台返回错误码为`100000`时，便认为是缺失了登录态。于是执行`wx.login`拿到`code`，再请求后台接口拿到登录态（`code`换`ticket`），然后将后台请求头中携带的`token`等信息种到`storage`中，然后刷新页面。下次请求从`storage`中拿到登录信息，放到`header`中，请求后台成功。

<img src="https://mike-1255355338.cos.ap-guangzhou.myqcloud.com/article/2024/11/own_mike_a2d957080d4dad2f5c.png" width="550">

上面黄色是前端请求，粉色是后台返回，绿色和红色是前端做的。其中“刷新页面”就是这次要优化的部分。

这里是小程序官网提供的[时序图](https://developers.weixin.qq.com/miniprogram/dev/framework/open-ability/login.html)。

如何优化呢？

首先需要引入装饰器，就是对请求做一层包裹，当后台返回 `100000` 的时候，不要直接 `reject` 了，而是记录当前请求、并监听登录接口（`code`换`ticket`）的成功事件。当登录成功后再次请求刚才记录的接口，并 `resolve` 这次的返回。

顺手在`wx.login`和`code`换`ticket`时，加了个“登录中”的`toast`。

<img src="https://mike-1255355338.cos.ap-guangzhou.myqcloud.com/article/2024/11/own_mike_693dc0bb411861d355.png" width="550">

这里面有几个核心点：

1. 这里的“重放”不是完全一样的请求，不是严格意义的重放。是对刚才失败的接口再次请求，请求参数不变，但请求头会变化
2. 要引入装饰器。因为拦截器很难做到重放，需要把它改造成异步，以及递归调用自己，还要维护一个失败队列，这会让拦截器变得很重
3. 要注意有可能多个接口都返回了`100000`，因为接口很有可能并发执行，需要将它们分别重放

说一下与上次优化的”无感登录`webview`“的区别：

登录`webview`时，`url`有额外特征（携带特殊`query`），所以可以根据这个控制接口并发为1，当请求登录成功后，就重新执行这个请求。

而小程序因为登录态有可能在任意时间失效，所以登录时机无法确定，导致并不能控制并发数为1。既然无法控制并发数，就只能在装饰器内分别记录每个请求了。


下面拿个具体的页面看下。

<img src="https://mike-1255355338.cos.ap-guangzhou.myqcloud.com/article/2024/11/own_mike_a347796c66c07b11b3.png" width="800">

- 第1个请求，无需登录态，直接返回了成功。

- 第2-4个请求是并发执行，需要登录态，但此时登录态失效，所以都返回了 `100000`。

- 第5个请求，是登录接口，会执行`code`换`ticket`。

- 第6-8个请求，是对刚才失败的请求（第2-4个）进行的重放。

通过上面的`Waterfall`还可以看出，`wx.login`执行也是花费了时间的，所以第4和第5个请求之间有一些间隔时间。

也可以看出登录接口（`code`换`ticket`）只返回了登录态信息，并没有返回业务信息，所以该接口仍需重放，所以这个CGI总共会被请求3次。

## 3. 效果

下面是和平赛场之前的效果，登录后有明显的刷新页面，刷新期间页面白屏：

<img src="https://mike-1255355338.cos.ap-guangzhou.myqcloud.com/article/2024/11/own_mike_19921f26ae20ec5be7.gif" width="380">

优化之后：

<img src="https://mike-1255355338.cos.ap-guangzhou.myqcloud.com/article/2024/11/own_mike_757fb02af679f762c3.gif" width="380">


下面是掼蛋赛事之前的效果：

<img src="https://mike-1255355338.cos.ap-guangzhou.myqcloud.com/article/2024/11/own_mike_450860049263fd4097.gif" width="380">

优化之后：

<img src="https://mike-1255355338.cos.ap-guangzhou.myqcloud.com/article/2024/11/own_mike_88a10e6b0da491ecf3.gif" width="380">


